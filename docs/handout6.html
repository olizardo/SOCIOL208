<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SOCIOL 208 - Community Structure</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="SOCIOL 208 - Community Structure">
<meta property="og:description" content="What are communities?">
<meta property="og:site-name" content="SOCIOL 208">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Community Structure</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">SOCIOL 208</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Home</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">208A</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllabus-208A.html" class="sidebar-item-text sidebar-link">208A Syllabus</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./schedule-208A-F24.html" class="sidebar-item-text sidebar-link">SOCIOL 208A Reading Schedule (Fall 2024)</a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Handouts</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./handout1.html" class="sidebar-item-text sidebar-link">Basic Network Statistics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inoutdegdist.html" class="sidebar-item-text sidebar-link">Graph Degree Metrics in Directed Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./handout2.html" class="sidebar-item-text sidebar-link">Centrality</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cube.html" class="sidebar-item-text sidebar-link">The Cube</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./handout3.html" class="sidebar-item-text sidebar-link">Status and Prestige</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./handout4.html" class="sidebar-item-text sidebar-link">Role Equivalence and Structural Similarity</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./handout5.html" class="sidebar-item-text sidebar-link">Vertex Similarity</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./handout6.html" class="sidebar-item-text sidebar-link active">Community Structure</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">208B</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllabus-208B.html" class="sidebar-item-text sidebar-link">208B Syllabus</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./schedule-208B-S24.html" class="sidebar-item-text sidebar-link">SOCIOL 208B Reading Schedule (Spring 2024)</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-are-communities" id="toc-what-are-communities" class="nav-link active" data-scroll-target="#what-are-communities">What are communities?</a></li>
  <li><a href="#a-bag-of-links" id="toc-a-bag-of-links" class="nav-link" data-scroll-target="#a-bag-of-links">A bag of links</a></li>
  <li><a href="#modularity-from-the-adjancency-matrix" id="toc-modularity-from-the-adjancency-matrix" class="nav-link" data-scroll-target="#modularity-from-the-adjancency-matrix">Modularity from the Adjancency Matrix</a></li>
  <li><a href="#the-modularity-matrix" id="toc-the-modularity-matrix" class="nav-link" data-scroll-target="#the-modularity-matrix">The Modularity Matrix</a></li>
  <li><a href="#using-the-modularity-matrix-to-find-communities" id="toc-using-the-modularity-matrix-to-find-communities" class="nav-link" data-scroll-target="#using-the-modularity-matrix-to-find-communities">Using the Modularity Matrix to Find Communities</a></li>
  <li><a href="#communities-versus-exogeneous-attributes" id="toc-communities-versus-exogeneous-attributes" class="nav-link" data-scroll-target="#communities-versus-exogeneous-attributes">Communities versus Exogeneous Attributes</a></li>
  <li><a href="#an-agglomerative-approach-based-on-the-modularity" id="toc-an-agglomerative-approach-based-on-the-modularity" class="nav-link" data-scroll-target="#an-agglomerative-approach-based-on-the-modularity">An Agglomerative Approach Based on the Modularity</a></li>
  <li><a href="#community-detection-using-edge-betweenness" id="toc-community-detection-using-edge-betweenness" class="nav-link" data-scroll-target="#community-detection-using-edge-betweenness">Community Detection Using Edge Betweenness</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/olizardo/SOCIOL208/blob/main/handout6.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Community Structure</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="what-are-communities" class="level2">
<h2 class="anchored" data-anchor-id="what-are-communities">What are communities?</h2>
<p>What are communities? In networks, communities are subset of nodes that have more interactions or connectivity within themselves than they do outside of themselves (these are sometimes called “modules” outside of sociology). Communities thus exemplify the sociological concept of a <strong>group</strong>.</p>
<p>A network has <em>community structure</em> if it contains many such subsets or groups of nodes that interact preferentially among themselves. Not all networks have to have community structure; a network in which all nodes interact with equal propensity doesn’t have communities.</p>
<p>So whether a network has community structure, and whether a given guess as to what these communities are yields actual <em>communities</em> (cluster of nodes that interact more among themselves than they do with outsiders) is an empirical question than needs to be answered with data.</p>
<p>But first, we need to develop a criterion for whether a given partition of the network into mutually exclusive node subsets is actually producing <em>communities</em> as we defined them earlier. This criterion should be independent of particular methods and algorithms that claim to find communities, so that way we can compare them with one another and see whether the partitions they recommend yield actual communities.</p>
<p>Mark Newman, who has done the most influential work in this area, proposed such a criterion and called it the <strong>modularity</strong> of a partition (e.g., the extent to which a partition has identified the “modules” or subsets of the network).</p>
</section>
<section id="a-bag-of-links" class="level2">
<h2 class="anchored" data-anchor-id="a-bag-of-links">A bag of links</h2>
<p>An intuitive way to understand the modularity is as follows. Imagine we have an idea of what the communities in a network are. This could be given by some special community partition method, our intuition, or some exogenous coloring on the nodes (e.g., as given by a node attribute like race, gender, position in the organization, etc.). The membership of each node in each community is thus stored in a vector, <span class="math inline">\(C_i = k\)</span> if node <span class="math inline">\(i\)</span> belongs to community <span class="math inline">\(k\)</span>.</p>
<p>Our job is to decide whether that community partition is a good one. One way to proceed is to imagine that we take the network in question, and we throw each observed link into a bag. Then our modularity measure should give us an idea of the probability that if we drew a link at random, the nodes at the end of each link belong to same community (or have the same color if the communities are defined by exogenous attributes). If the probability is high, then the network has community structure. If the probability is no better than we would expect given a null model that says there is nothing going on in the network connectivity-wise except random chance, then the modularity should be low (and we decide that the partition we chose actually does not divide the network into meaningful communities).</p>
<p>Let’s assume our bag of links is full of directed links and we draw a bunch of them at random. Let’s call the node at the starting end of the link <span class="math inline">\(s\)</span> and the node at the destination end of the link <span class="math inline">\(d\)</span>. Then we can measure the modularity—let’s call it <span class="math inline">\(Q\)</span>—of a given partition of the network into <span class="math inline">\(m\)</span> clusters as follows:</p>
<p><span class="math display">\[
Q &lt;- \sum_{k = 1}^m \left[P(s \in k \land d \in k) - P(s \in k) \times P(d \in k) \right]
\]</span></p>
<p>In this equation, <span class="math inline">\(P(s \in k \land d \in k)\)</span> is the probability that a link drawn at random has a source and a destination node that belong to the same community <span class="math inline">\(k\)</span>; <span class="math inline">\(P(s \in k)\)</span> is just the probability of drawing a link that has a starting node in community <span class="math inline">\(k\)</span> (regardless of the membership of the destination node) and <span class="math inline">\(P(d \in k)\)</span> is the probability of drawing a link that has a destination node that belongs to community <span class="math inline">\(k\)</span> (regardless of the membership fo the source node).</p>
<p>If you remember your elementary probability theory, you know that the <em>joint</em> probability of two events that are assumed to be <em>independent</em> of one another is just the product of their individual probabilities. So that means that <span class="math inline">\(P(s \in k) \times P(d \in k)\)</span> is the expected probability of finding that both the source and destination node are in the same community <span class="math inline">\(k\)</span> in a network in which communities don’t matter for link formation (because the two probabilities are assumed to be independent).</p>
<p>So the formula for the modularity subtracts the observed probability of finding links with two nodes in the same community from what we would expect if communities didn’t matter. So it measures the extent to which we find within-community links in the network beyond what we would expect by chance. Obviously, the higher this number, the higher the deviation from chance is, and the more community structure there is in the network.</p>
<p>Let’s move to a real example. Below are two plots of the advice network from the <code>law_friends</code> data from the <code>networkdata</code> package. The first shows the nodes colored by status in the firm (partners versus associates) and the other shows the nodes colored by gender. It is pretty evident that there is more community by status than by gender; that is, friendship nominations tend to go from people of a given rank to people of the same rank, which makes sense. So a measure of modularity should be higher when using status as our partition than when using gender.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="handout6_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Law Firm Friendship Network by Status</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="handout6_files/figure-html/unnamed-chunk-1-2.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Law Firm Friendship Network by Gender</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Let’s see an example of the modularity computed using our “bag of links” framework. Below is a quick function that uses <code>dplyr</code> code to take a graph as input and return and <strong>edge list</strong> data frame containing the “community membership” of each node by some characteristic given by the second input into the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>   link.bag <span class="ot">&lt;-</span> <span class="cf">function</span>(x, c) {</span>
<span id="cb1-2"><a href="#cb1-2"></a>      <span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3"></a>      g.el <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">as_edgelist</span>(x))</span>
<span id="cb1-4"><a href="#cb1-4"></a>      <span class="fu">names</span>(g.el) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"vi"</span>, <span class="st">"vj"</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a>      comm.dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">vi =</span> <span class="fu">as.vector</span>(<span class="fu">V</span>(x)), </span>
<span id="cb1-6"><a href="#cb1-6"></a>                             <span class="at">vj =</span> <span class="fu">as.vector</span>(<span class="fu">V</span>(x)), </span>
<span id="cb1-7"><a href="#cb1-7"></a>                             <span class="at">c =</span> <span class="fu">as.vector</span>(c))</span>
<span id="cb1-8"><a href="#cb1-8"></a>      el.temp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">vj =</span> g.el[, <span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb1-9"><a href="#cb1-9"></a>         <span class="fu">left_join</span>(comm.dat, <span class="at">by =</span> <span class="st">"vj"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-10"><a href="#cb1-10"></a>         dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"vj"</span>, <span class="st">"c"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-11"><a href="#cb1-11"></a>         <span class="fu">rename</span>(<span class="at">c2 =</span> c) </span>
<span id="cb1-12"><a href="#cb1-12"></a>      d.el <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">vi =</span> g.el[, <span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb1-13"><a href="#cb1-13"></a>         <span class="fu">left_join</span>(comm.dat, <span class="at">by =</span> <span class="st">"vi"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-14"><a href="#cb1-14"></a>         dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">"vi"</span>, <span class="st">"c"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-15"><a href="#cb1-15"></a>         <span class="fu">rename</span>(<span class="at">c1 =</span> c) <span class="sc">%&gt;%</span> </span>
<span id="cb1-16"><a href="#cb1-16"></a>         <span class="fu">cbind</span>(el.temp)</span>
<span id="cb1-17"><a href="#cb1-17"></a>   <span class="fu">return</span>(d.el)</span>
<span id="cb1-18"><a href="#cb1-18"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So if we wanted an edge list data frame containing each node’s status membership in the <code>law_advice</code> network, we would just type:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>   link.dat <span class="ot">&lt;-</span> <span class="fu">link.bag</span>(g, <span class="fu">V</span>(g)<span class="sc">$</span>status)</span>
<span id="cb2-2"><a href="#cb2-2"></a>   <span class="fu">head</span>(link.dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  vi c1 vj c2
1  1  1  2  1
2  1  1  4  1
3  1  1  8  1
4  1  1 17  1
5  2  1 16  1
6  2  1 17  1</code></pre>
</div>
</div>
<p>Note than an edge list is already a “bag of links” so we can compute the three probabilities we need to compute the modularity of a partition directly from the edge list data frame. Here’s a function that does this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>   mod.Q1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">c1 =</span> <span class="dv">2</span>, <span class="at">c2 =</span> <span class="dv">4</span>) {</span>
<span id="cb4-2"><a href="#cb4-2"></a>      Q <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>      comms <span class="ot">&lt;-</span> <span class="fu">unique</span>(x[, c1])</span>
<span id="cb4-4"><a href="#cb4-4"></a>      <span class="cf">for</span> (k <span class="cf">in</span> comms) {</span>
<span id="cb4-5"><a href="#cb4-5"></a>         e.same <span class="ot">&lt;-</span> x[x[, c1] <span class="sc">==</span> k <span class="sc">&amp;</span> x[, c2] <span class="sc">==</span> k, ]</span>
<span id="cb4-6"><a href="#cb4-6"></a>         e.sour <span class="ot">&lt;-</span> x[x[, c1] <span class="sc">==</span> k, ]</span>
<span id="cb4-7"><a href="#cb4-7"></a>         e.dest <span class="ot">&lt;-</span> x[x[, c2] <span class="sc">==</span> k, ]</span>
<span id="cb4-8"><a href="#cb4-8"></a>         e.total <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb4-9"><a href="#cb4-9"></a>         p.same <span class="ot">&lt;-</span> <span class="fu">nrow</span>(e.same)<span class="sc">/</span>e.total</span>
<span id="cb4-10"><a href="#cb4-10"></a>         p.sour <span class="ot">&lt;-</span> <span class="fu">nrow</span>(e.sour)<span class="sc">/</span>e.total</span>
<span id="cb4-11"><a href="#cb4-11"></a>         p.dest <span class="ot">&lt;-</span> <span class="fu">nrow</span>(e.dest)<span class="sc">/</span>e.total</span>
<span id="cb4-12"><a href="#cb4-12"></a>         Q <span class="ot">&lt;-</span> Q <span class="sc">+</span> (p.same <span class="sc">-</span> (p.sour <span class="sc">*</span> p.dest))</span>
<span id="cb4-13"><a href="#cb4-13"></a>      }</span>
<span id="cb4-14"><a href="#cb4-14"></a>   <span class="fu">return</span>(Q)</span>
<span id="cb4-15"><a href="#cb4-15"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function takes the edge list data frame as input. Optionally, you can specify the two columns containing community membership info for the source and destination node in each link (in this case this happens to be the second and fourth columns). The Function works like this:</p>
<ul>
<li><p>The probability of a link drawn randomly from the bag is just the number of links where the source and destination links belong to the same community (<code>e.same</code>, computed in line 5) divided by the total number of links (which is the number of rows in the edge list data frame), this ratio is computed in line 9 (<code>p.same</code>).</p></li>
<li><p>The overall probability of a link containing a <em>source</em> node in community <span class="math inline">\(k\)</span> is computed in line 10 (<code>p.sour</code>), and the overall probability of a link containing a <em>destination</em> node in community <span class="math inline">\(k\)</span> is computed in line 11 (<code>p.dest</code>).</p></li>
<li><p>The actual modularity is computed step by step by summation across levels of the community indicator variable in line 12 which is the sum of the difference between <code>p.same</code> and the product of <code>p.sour</code> times <code>p.dest</code> across all communities <span class="math inline">\(m\)</span> (in this case <span class="math inline">\(m = 2\)</span> as there are only two levels of status).</p></li>
</ul>
<p>So if wanted to check if status was more powerful in structuring the community organization of the <code>law_friends</code> network than gender, we would just type:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>   <span class="fu">mod.Q1</span>(<span class="fu">link.bag</span>(g, <span class="fu">V</span>(g)<span class="sc">$</span>status))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2715221</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>   <span class="fu">mod.Q1</span>( <span class="fu">link.bag</span>(g, <span class="fu">V</span>(g)<span class="sc">$</span>gender))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07495538</code></pre>
</div>
</div>
<p>Which indeed confirms that status is a more powerful group formation principle than gender in this network.</p>
</section>
<section id="modularity-from-the-adjancency-matrix" class="level2">
<h2 class="anchored" data-anchor-id="modularity-from-the-adjancency-matrix">Modularity from the Adjancency Matrix</h2>
<p>Note that while the “bag of links” idea is good for showing the basic probabilistic principle behind the modularity in a network, we can compute directly from the adjacency matrix without going through the edge list data frame construction step.</p>
<p>A function that does this looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>   mod.Q2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, c) {</span>
<span id="cb9-2"><a href="#cb9-2"></a>   A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(x))</span>
<span id="cb9-3"><a href="#cb9-3"></a>   vol <span class="ot">&lt;-</span> <span class="fu">sum</span>(A)</span>
<span id="cb9-4"><a href="#cb9-4"></a>   Q <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>   <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">unique</span>(c)) {</span>
<span id="cb9-6"><a href="#cb9-6"></a>      A.sub <span class="ot">&lt;-</span> A[<span class="fu">which</span>(c <span class="sc">==</span> k), <span class="fu">which</span>(c <span class="sc">==</span> k)]</span>
<span id="cb9-7"><a href="#cb9-7"></a>      vol.k <span class="ot">&lt;-</span> <span class="fu">sum</span>(A.sub)</span>
<span id="cb9-8"><a href="#cb9-8"></a>      A.i <span class="ot">&lt;-</span> A[<span class="fu">which</span>(c <span class="sc">==</span> k), ]</span>
<span id="cb9-9"><a href="#cb9-9"></a>      A.j <span class="ot">&lt;-</span> A[, <span class="fu">which</span>(c <span class="sc">==</span> k)]</span>
<span id="cb9-10"><a href="#cb9-10"></a>      Q <span class="ot">&lt;-</span> Q <span class="sc">+</span> ((vol.k<span class="sc">/</span>vol) <span class="sc">-</span> ((<span class="fu">sum</span>(A.i) <span class="sc">*</span> <span class="fu">sum</span>(A.j))<span class="sc">/</span>vol<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb9-11"><a href="#cb9-11"></a>      }</span>
<span id="cb9-12"><a href="#cb9-12"></a>   <span class="fu">return</span>(Q)</span>
<span id="cb9-13"><a href="#cb9-13"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function just takes a graph and a vector indicating the community membership of each node and returns the modularity as output. Like before the modularity is the difference in the probability of observing a within-community link between two nodes (given by the ratio of the number of links in the sub-adjacency matrix containing only within community-nodes—obtained in line 7—and the overall number of links in the adjacency matrix, computed in line 3) and the <em>expected</em> probability of a link between a source node with community membership <span class="math inline">\(k\)</span> and a destination node with the same community membership.</p>
<p>This last quantity is given by the product of the sum links in a the sub-adjacency matrix with <em>row nodes</em> that belong to community <span class="math inline">\(k\)</span> (the source nodes) and the number of links in the sub adjacency matrix with the <em>column nodes</em> belonging to community <span class="math inline">\(k\)</span> (the destination nodes) divided by the <em>square</em> of the total number of links observed the network.</p>
<p>In formulese:</p>
<p><span class="math display">\[\begin{equation}
Q = \sum_{k=1}^m \left[\frac{\sum_{i \in k} \sum_{j \in k} a_{ij}}{\sum_i \sum_j a_{ij}}  - \frac{(\sum_{i \in k} \sum_j a_{ij})(\sum_i \sum_{j \in k} a_{ij})}{(\sum_i \sum_j a_{ij})^2} \right]
\end{equation}\]</span></p>
<p>Where <span class="math inline">\(\sum_i \sum_ja_{ij}\)</span> is the sum of all the entries in the network adjacency matrix, <span class="math inline">\(\sum_{i \in k} \sum_{j \in k} a_{ij}\)</span> is the sum of all the entries of the sub-adjacency matrix where <em>both</em> the row and column nodes come from community <span class="math inline">\(k\)</span>, <span class="math inline">\(\sum_{i \in k} \sum_j a_{ij}\)</span> is the sum of all the entries in the sub-adjacency matrix where only the row nodes come from community <span class="math inline">\(k\)</span>, and <span class="math inline">\(\sum_i \sum_{j \in k} a_{ij}\)</span> is the sum of all the entries in the sub-adjacency matrix where only the column nodes come from community <span class="math inline">\(k\)</span>.</p>
<p>We can easily see that this approach gives us the same answer as the bag of links version:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>   <span class="fu">mod.Q2</span>(g, <span class="fu">V</span>(g)<span class="sc">$</span>status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2715221</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>   <span class="fu">mod.Q2</span>(g, <span class="fu">V</span>(g)<span class="sc">$</span>gender)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07495538</code></pre>
</div>
</div>
<p>Of course, you don’t even have to use a custom function like the above, because <code>igraph</code> has one, called (you guessed it) <code>modularity</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>   <span class="fu">modularity</span>(g, <span class="fu">V</span>(g)<span class="sc">$</span>status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2715221</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>   <span class="fu">modularity</span>(g, <span class="fu">V</span>(g)<span class="sc">$</span>gender)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07495538</code></pre>
</div>
</div>
<p>But at least now you know what’s going on inside of it!</p>
</section>
<section id="the-modularity-matrix" class="level2">
<h2 class="anchored" data-anchor-id="the-modularity-matrix">The Modularity Matrix</h2>
<p>Obviously, the modularity wouldn’t be a famous method if it was just a way of measuring the goodness of a community partition produced by other methods. It itself can be used to find community partitions by using a method that somehow produces node partition that find the largest values that it can take in a graph.</p>
<p>A useful tool in this quest is what is called the <strong>modularity matrix</strong> (<span class="math inline">\(\mathbf{B}\)</span>), which is defined as a variation on the adjacency matrix (<span class="math inline">\(\mathbf{A}\)</span>), with each cell <span class="math inline">\(b_{ij}\)</span> taking having the value:</p>
<p><span class="math display">\[
b_{ij} = a_{ij} - \frac{k^{out}_ik^{in}_j}{\sum_i\sum_j a_{ij}}
\]</span></p>
<p>Where <span class="math inline">\(k^{out}_i\)</span> is node <span class="math inline">\(i\)</span>’s outdegree and <span class="math inline">\(k^{in}_j\)</span> is node j’s indegree. Note that the modularity matrix has the same “observed minus expected” structure as the formulas for the modularity. In this case we compare whether we see a link from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span> as given by <span class="math inline">\(a_{ij}\)</span> against the probability of observing a link in a graph in which nodes connect at random with probability proportional to their degrees (as given by the right-hand side fraction).</p>
<p>Note that if the graph is undirected, the modularity is just:</p>
<p><span class="math display">\[
b_{ij} = a_{ij} - \frac{k_ik_j}{\sum_i\sum_j a_{ij}}
\]</span></p>
<p>A function to compute the modularity matrix by looping through every element of the adjacency matrix for a directed graph looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>   mod.mat <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb18-2"><a href="#cb18-2"></a>      A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(x))</span>
<span id="cb18-3"><a href="#cb18-3"></a>      od <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(A) <span class="co">#outdegrees</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>      id <span class="ot">&lt;-</span> <span class="fu">colSums</span>(A) <span class="co">#indegrees</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>      vol <span class="ot">&lt;-</span> <span class="fu">sum</span>(A)</span>
<span id="cb18-6"><a href="#cb18-6"></a>      n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(A)</span>
<span id="cb18-7"><a href="#cb18-7"></a>      B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, n)</span>
<span id="cb18-8"><a href="#cb18-8"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb18-9"><a href="#cb18-9"></a>         <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb18-10"><a href="#cb18-10"></a>            B[i,j] <span class="ot">&lt;-</span> A[i,j] <span class="sc">-</span> ((od[i]<span class="sc">*</span>id[j])<span class="sc">/</span>vol)</span>
<span id="cb18-11"><a href="#cb18-11"></a>         }</span>
<span id="cb18-12"><a href="#cb18-12"></a>      }</span>
<span id="cb18-13"><a href="#cb18-13"></a>   <span class="fu">return</span>(B)</span>
<span id="cb18-14"><a href="#cb18-14"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Peeking inside the resulting matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>   <span class="fu">round</span>(<span class="fu">mod.mat</span>(g)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]   [,2]   [,3]   [,4]   [,5]   [,6]   [,7]   [,8]   [,9]  [,10]
 [1,] -0.035  0.930 -0.028  0.902 -0.035 -0.014 -0.014  0.951 -0.098 -0.028
 [2,] -0.035 -0.070 -0.028 -0.098 -0.035 -0.014 -0.014 -0.049 -0.098 -0.028
 [3,]  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000
 [4,] -0.131  0.739  0.895 -0.366 -0.131 -0.052 -0.052 -0.183  0.634 -0.105
 [5,] -0.026 -0.052 -0.021 -0.073 -0.026 -0.010  0.990 -0.037 -0.073 -0.021
 [6,]  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000
 [7,] -0.017 -0.035  0.986 -0.049  0.983 -0.007 -0.007 -0.024 -0.049 -0.014
 [8,] -0.009 -0.017 -0.007 -0.024 -0.009 -0.003 -0.003 -0.012 -0.024 -0.007
 [9,] -0.052 -0.105 -0.042  0.854 -0.052 -0.021 -0.021 -0.073 -0.146 -0.042
[10,] -0.122  0.756 -0.098 -0.341 -0.122 -0.049 -0.049  0.829  0.659 -0.098</code></pre>
</div>
</div>
<p>Interestingly, the matrix has some negative entries, some positive entries and some close to or actually zero. We interpret these as follows: If an entry is negative it means that a link between the row and column nodes is much less likely to happened than expected given the each node’s degrees, a positive entry indicates the opposite; a larger than expected chance of a link forming. Entries close to zero indicate those nodes have odds close to random chance of forming a tie.</p>
<p>Of course <code>igraph</code> has a function, called <code>modularity_matrix</code>, which gives us the same result:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>   B <span class="ot">&lt;-</span> <span class="fu">modularity_matrix</span>(g)</span>
<span id="cb21-2"><a href="#cb21-2"></a>   <span class="fu">round</span>(B[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]   [,2]   [,3]   [,4]   [,5]   [,6]   [,7]   [,8]   [,9]  [,10]
 [1,] -0.035  0.930 -0.028  0.902 -0.035 -0.014 -0.014  0.951 -0.098 -0.028
 [2,] -0.035 -0.070 -0.028 -0.098 -0.035 -0.014 -0.014 -0.049 -0.098 -0.028
 [3,]  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000
 [4,] -0.131  0.739  0.895 -0.366 -0.131 -0.052 -0.052 -0.183  0.634 -0.105
 [5,] -0.026 -0.052 -0.021 -0.073 -0.026 -0.010  0.990 -0.037 -0.073 -0.021
 [6,]  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000
 [7,] -0.017 -0.035  0.986 -0.049  0.983 -0.007 -0.007 -0.024 -0.049 -0.014
 [8,] -0.009 -0.017 -0.007 -0.024 -0.009 -0.003 -0.003 -0.012 -0.024 -0.007
 [9,] -0.052 -0.105 -0.042  0.854 -0.052 -0.021 -0.021 -0.073 -0.146 -0.042
[10,] -0.122  0.756 -0.098 -0.341 -0.122 -0.049 -0.049  0.829  0.659 -0.098</code></pre>
</div>
</div>
<p>In the case of an undirected graph, computing the modularity is even simpler:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>   mod.mat.u <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb23-2"><a href="#cb23-2"></a>      A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(x))</span>
<span id="cb23-3"><a href="#cb23-3"></a>      d <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(A) <span class="co">#degrees</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>      vol <span class="ot">&lt;-</span> <span class="fu">sum</span>(A)</span>
<span id="cb23-5"><a href="#cb23-5"></a>      n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(A)</span>
<span id="cb23-6"><a href="#cb23-6"></a>      B <span class="ot">&lt;-</span> A <span class="sc">-</span> (d <span class="sc">%*%</span> <span class="fu">t</span>(d)<span class="sc">/</span>vol)</span>
<span id="cb23-7"><a href="#cb23-7"></a>   <span class="fu">return</span>(B)</span>
<span id="cb23-8"><a href="#cb23-8"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see the function in action:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>   ug <span class="ot">&lt;-</span> <span class="fu">as_undirected</span>(g, <span class="at">mode =</span> <span class="st">"collapse"</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a>   Bu <span class="ot">&lt;-</span> <span class="fu">mod.mat.u</span>(ug)</span>
<span id="cb24-3"><a href="#cb24-3"></a>   <span class="fu">round</span>(Bu[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10]
 [1,] -0.08  0.90 -0.04  0.78 -0.06 -0.02 -0.03  0.93 -0.14 -0.14
 [2,]  0.90 -0.13 -0.05  0.72 -0.08 -0.03 -0.04 -0.09 -0.18  0.82
 [3,] -0.04 -0.05 -0.02  0.89 -0.03 -0.01  0.98 -0.04 -0.07 -0.07
 [4,]  0.78  0.72  0.89 -0.61 -0.17 -0.06 -0.08 -0.19  0.61 -0.39
 [5,] -0.06 -0.08 -0.03 -0.17 -0.05 -0.02  0.98 -0.05 -0.11 -0.11
 [6,] -0.02 -0.03 -0.01 -0.06 -0.02 -0.01 -0.01 -0.02 -0.04 -0.04
 [7,] -0.03 -0.04  0.98 -0.08  0.98 -0.01 -0.01 -0.03 -0.05 -0.05
 [8,]  0.93 -0.09 -0.04 -0.19 -0.05 -0.02 -0.03 -0.06 -0.12  0.88
 [9,] -0.14 -0.18 -0.07  0.61 -0.11 -0.04 -0.05 -0.12 -0.25  0.75
[10,] -0.14  0.82 -0.07 -0.39 -0.11 -0.04 -0.05  0.88  0.75 -0.25</code></pre>
</div>
</div>
<p>Which gives us the same results as using <code>igraph</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>   Bu <span class="ot">&lt;-</span> <span class="fu">modularity_matrix</span>(ug, <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a>   <span class="fu">round</span>(Bu[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10]
 [1,] -0.08  0.90 -0.04  0.78 -0.06 -0.02 -0.03  0.93 -0.14 -0.14
 [2,]  0.90 -0.13 -0.05  0.72 -0.08 -0.03 -0.04 -0.09 -0.18  0.82
 [3,] -0.04 -0.05 -0.02  0.89 -0.03 -0.01  0.98 -0.04 -0.07 -0.07
 [4,]  0.78  0.72  0.89 -0.61 -0.17 -0.06 -0.08 -0.19  0.61 -0.39
 [5,] -0.06 -0.08 -0.03 -0.17 -0.05 -0.02  0.98 -0.05 -0.11 -0.11
 [6,] -0.02 -0.03 -0.01 -0.06 -0.02 -0.01 -0.01 -0.02 -0.04 -0.04
 [7,] -0.03 -0.04  0.98 -0.08  0.98 -0.01 -0.01 -0.03 -0.05 -0.05
 [8,]  0.93 -0.09 -0.04 -0.19 -0.05 -0.02 -0.03 -0.06 -0.12  0.88
 [9,] -0.14 -0.18 -0.07  0.61 -0.11 -0.04 -0.05 -0.12 -0.25  0.75
[10,] -0.14  0.82 -0.07 -0.39 -0.11 -0.04 -0.05  0.88  0.75 -0.25</code></pre>
</div>
</div>
<p>The modularity matrix has some interesting properties. For instance, <em>both</em> its rows and columns sum to zero:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>   <span class="fu">round</span>(<span class="fu">rowSums</span>(Bu), <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
[39] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>   <span class="fu">round</span>(<span class="fu">colSums</span>(Bu), <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
[39] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</code></pre>
</div>
</div>
<p>Which makes <span class="math inline">\(\mathbf{B}\)</span> <strong>doubly centered</strong> a neat but so far useless property.</p>
</section>
<section id="using-the-modularity-matrix-to-find-communities" class="level2">
<h2 class="anchored" data-anchor-id="using-the-modularity-matrix-to-find-communities">Using the Modularity Matrix to Find Communities</h2>
<p>Here’s a more useful property. Remember the network distribution game we played to defined our various reflective status measure in Handout 3?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>   status1 <span class="ot">&lt;-</span> <span class="cf">function</span>(A) {</span>
<span id="cb32-2"><a href="#cb32-2"></a>      n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(A) <span class="co">#number of actors</span></span>
<span id="cb32-3"><a href="#cb32-3"></a>      x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, n) <span class="co">#initial status vector set to all ones</span></span>
<span id="cb32-4"><a href="#cb32-4"></a>      w <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb32-5"><a href="#cb32-5"></a>      k <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#initializing counter</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>      <span class="cf">while</span> (w <span class="sc">&gt;</span> <span class="fl">0.0001</span>) {</span>
<span id="cb32-7"><a href="#cb32-7"></a>          o.x <span class="ot">&lt;-</span> x <span class="co">#old status scores</span></span>
<span id="cb32-8"><a href="#cb32-8"></a>          x <span class="ot">&lt;-</span> A <span class="sc">%*%</span> x <span class="co">#new scores a function of old scores and adjacency matrix</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>          x <span class="ot">&lt;-</span> x<span class="sc">/</span><span class="fu">norm</span>(x, <span class="at">type =</span> <span class="st">"E"</span>) <span class="co">#normalizing new status scores</span></span>
<span id="cb32-10"><a href="#cb32-10"></a>          w <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">sum</span>(<span class="fu">abs</span>(x) <span class="sc">-</span> <span class="fu">abs</span>(o.x))) <span class="co">#diff. between new and old scores</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>          k <span class="ot">&lt;-</span> k <span class="sc">+</span> <span class="dv">1</span> <span class="co">#incrementing while counter</span></span>
<span id="cb32-12"><a href="#cb32-12"></a>      }</span>
<span id="cb32-13"><a href="#cb32-13"></a>   <span class="fu">return</span>(<span class="fu">as.vector</span>(x))</span>
<span id="cb32-14"><a href="#cb32-14"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What if we played it with the modularity matrix?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>   s <span class="ot">&lt;-</span> <span class="fu">status1</span>(Bu)</span>
<span id="cb33-2"><a href="#cb33-2"></a>   <span class="fu">round</span>(s,<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] -0.10 -0.14 -0.02 -0.21 -0.03  0.00  0.01 -0.05 -0.21 -0.18 -0.16 -0.24
[13] -0.13 -0.06 -0.04 -0.12 -0.24  0.08 -0.03 -0.17 -0.18 -0.15 -0.09 -0.14
[25] -0.11 -0.17 -0.19  0.04 -0.10 -0.02  0.11  0.06  0.06 -0.06  0.10  0.01
[37] -0.05  0.04 -0.05  0.12  0.19 -0.02  0.07  0.05  0.02  0.08  0.08  0.09
[49]  0.17  0.00  0.20  0.06  0.20  0.13  0.20  0.09  0.08  0.05  0.06  0.02
[61]  0.24  0.14  0.17  0.06  0.13  0.09  0.09  0.09</code></pre>
</div>
</div>
<p>This seems more interesting. The resulting “status” vector has both negative and positive entries. What if I told you that this vector is actual a <strong>partition</strong> of the original graph into two communities?</p>
<p>Not only that, I have even better news. This is the partition that <em>maximizes</em> the modularity in the graph, the best two-group partition that has the most edges within groups and the least edges going across groups.</p>
<p>Let’s see some evidence for these claims in real data.</p>
<p>First, let’s turn the “status” vector into a community indicator vector. We assign all nodes with scores larger than zero to one community and nodes with scores equal to zero or less to the other one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>   C <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(s))</span>
<span id="cb35-2"><a href="#cb35-2"></a>   C[<span class="fu">which</span>(s<span class="sc">&lt;=</span><span class="dv">0</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>   C[<span class="fu">which</span>(s <span class="sc">&gt;</span><span class="dv">0</span>)] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>   <span class="fu">names</span>(C) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(C)</span>
<span id="cb35-5"><a href="#cb35-5"></a>   C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  1  1  1  2  2  1  1  1  1  1  1  1  1  1  1  2  1  1  1  1  1  1  1  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  2  1  1  2  2  2  1  2  2  1  2  1  2  2  1  2  2  2  2  2  2  2  2  2  2 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
 2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 </code></pre>
</div>
</div>
<p>And for the big check:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>   <span class="fu">modularity</span>(ug, C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2935153</code></pre>
</div>
</div>
<p>Which is a pretty big score, at least larger than we obtained earlier using the exogenous indicator of status in the law firm as the basis for a binary partition.</p>
<p>Here’s some visual evidence:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>   <span class="fu">V</span>(ug)<span class="sc">$</span>color <span class="ot">&lt;-</span> C</span>
<span id="cb39-2"><a href="#cb39-2"></a>   <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb39-3"><a href="#cb39-3"></a>   <span class="fu">plot</span>(ug, </span>
<span id="cb39-4"><a href="#cb39-4"></a>     <span class="at">vertex.size=</span><span class="dv">6</span>, <span class="at">vertex.frame.color=</span><span class="st">"lightgray"</span>, </span>
<span id="cb39-5"><a href="#cb39-5"></a>     <span class="at">vertex.label =</span> <span class="cn">NA</span>, <span class="at">edge.arrow.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb39-6"><a href="#cb39-6"></a>     <span class="at">vertex.label.dist=</span><span class="dv">1</span>, <span class="at">edge.curved=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="handout6_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Law Firm Friendship Network by The Best Binary Partition According to the Modularity</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Which definitely looks like an optimal clustering into two groups based on friendship!</p>
<p>Of course, you may also remember from the status handout that the little status game we played above is also a method (called the “power” method) of computing the <strong>leading eigenvector</strong> (the one associated with the largest eigenvalue) of a matrix. So turns out that the modularity maximizing bi-partition of a graph is just given by this vector:</p>
<p><span class="math display">\[
\mathbf{B}\mathbf{v} = \lambda\mathbf{v}
\]</span></p>
<p>Solving for <span class="math inline">\(\mathbf{v}\)</span> in the equation above will give us the community memberships of the nodes. In <code>R</code> you can do this using the native <code>eigen</code> function like we did for the status scores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>   v <span class="ot">&lt;-</span> <span class="fu">eigen</span>(Bu)<span class="sc">$</span>vectors[, <span class="dv">1</span>] </span>
<span id="cb40-2"><a href="#cb40-2"></a>   <span class="fu">round</span>(v, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] -0.10 -0.14 -0.02 -0.21 -0.03  0.00  0.01 -0.05 -0.21 -0.18 -0.16 -0.24
[13] -0.13 -0.06 -0.04 -0.12 -0.24  0.08 -0.03 -0.17 -0.18 -0.15 -0.09 -0.14
[25] -0.11 -0.17 -0.19  0.04 -0.10 -0.02  0.11  0.06  0.06 -0.06  0.10  0.01
[37] -0.05  0.04 -0.05  0.12  0.19 -0.02  0.07  0.05  0.02  0.08  0.08  0.09
[49]  0.17  0.00  0.20  0.06  0.20  0.13  0.20  0.09  0.08  0.05  0.06  0.02
[61]  0.24  0.14  0.17  0.06  0.13  0.09  0.09  0.09</code></pre>
</div>
</div>
<p>Which look like the same values we obtained earlier.</p>
<p>We can package all of the steps above into a simple function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>   split.two <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb42-2"><a href="#cb42-2"></a>      e <span class="ot">&lt;-</span> <span class="fu">eigen</span>(x)<span class="sc">$</span>vectors[, <span class="dv">1</span>]</span>
<span id="cb42-3"><a href="#cb42-3"></a>      v <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(e))</span>
<span id="cb42-4"><a href="#cb42-4"></a>      v[e<span class="sc">&lt;=</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb42-5"><a href="#cb42-5"></a>      v[e <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb42-6"><a href="#cb42-6"></a>      <span class="fu">names</span>(v) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(v)</span>
<span id="cb42-7"><a href="#cb42-7"></a>      c1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(v))</span>
<span id="cb42-8"><a href="#cb42-8"></a>      c2 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(v))</span>
<span id="cb42-9"><a href="#cb42-9"></a>      c1[<span class="fu">which</span>(v <span class="sc">==</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb42-10"><a href="#cb42-10"></a>      c2[<span class="fu">which</span>(v <span class="sc">==</span> <span class="dv">2</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb42-11"><a href="#cb42-11"></a>      dummy <span class="ot">&lt;-</span> <span class="fu">cbind</span>(c1, c2)</span>
<span id="cb42-12"><a href="#cb42-12"></a>   <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">v =</span> v, <span class="at">dummy =</span> dummy))</span>
<span id="cb42-13"><a href="#cb42-13"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And check to see if it works:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>   <span class="fu">split.two</span>(Bu)<span class="sc">$</span>v</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  1  1  1  2  2  1  1  1  1  1  1  1  1  1  1  2  1  1  1  1  1  1  1  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  2  1  1  2  2  2  1  2  2  1  2  1  2  2  1  2  2  2  2  2  2  2  2  2  2 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
 2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 </code></pre>
</div>
</div>
<p>Indeed it splits the nodes in a graph into two modularity maximizing communities.</p>
<p>It is clear that this approach hints at a divisive partitioning strategy, where we begin with two communities and then try to split one (or both) of those communities into two more like with CONCOR.</p>
<p>However, unlike CONCOR, We don’t want to be unprincipled here because splitting a well-defined community into two just for the hell of it, can actually lead to <em>worse</em> modularity than keeping the original larger communities.</p>
<p>So we need an approach that <em>tries out</em> splitting one of the original two communities into two smaller ones, checks the new modularity, compares it with the old, and only goes ahead with the partition if the new modularity is larger than the old one.</p>
<p>Here’s one way of doing that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>   split.mult <span class="ot">&lt;-</span> <span class="cf">function</span>(B, vol, u, v, <span class="at">s =</span> <span class="fl">0.01</span>) {</span>
<span id="cb45-2"><a href="#cb45-2"></a>      split <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-3"><a href="#cb45-3"></a>      delta.Q <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">max</span>(v))</span>
<span id="cb45-4"><a href="#cb45-4"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(v)) {</span>
<span id="cb45-5"><a href="#cb45-5"></a>         old.Q <span class="ot">&lt;-</span> <span class="fu">t</span>(u[, i]) <span class="sc">%*%</span> B <span class="sc">%*%</span> u[, i]</span>
<span id="cb45-6"><a href="#cb45-6"></a>         sub <span class="ot">&lt;-</span> <span class="fu">which</span>(u[, i] <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb45-7"><a href="#cb45-7"></a>         new.B <span class="ot">&lt;-</span> B[sub, sub]</span>
<span id="cb45-8"><a href="#cb45-8"></a>         new.u <span class="ot">&lt;-</span> <span class="fu">split.two</span>(new.B)<span class="sc">$</span>dummy</span>
<span id="cb45-9"><a href="#cb45-9"></a>         new.v <span class="ot">&lt;-</span> <span class="fu">split.two</span>(new.B)<span class="sc">$</span>v</span>
<span id="cb45-10"><a href="#cb45-10"></a>         Q1 <span class="ot">&lt;-</span> <span class="fu">t</span>(new.u[, <span class="dv">1</span>]) <span class="sc">%*%</span> new.B <span class="sc">%*%</span> new.u[, <span class="dv">1</span>]</span>
<span id="cb45-11"><a href="#cb45-11"></a>         Q2 <span class="ot">&lt;-</span> <span class="fu">t</span>(new.u[, <span class="dv">2</span>]) <span class="sc">%*%</span> new.B <span class="sc">%*%</span> new.u[, <span class="dv">2</span>]</span>
<span id="cb45-12"><a href="#cb45-12"></a>         new.Q <span class="ot">&lt;-</span> Q1 <span class="sc">+</span> Q2</span>
<span id="cb45-13"><a href="#cb45-13"></a>         delta.Q[i] <span class="ot">&lt;-</span> (new.Q <span class="sc">-</span> old.Q) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>vol)</span>
<span id="cb45-14"><a href="#cb45-14"></a>         <span class="cf">if</span> (delta.Q[i] <span class="sc">&gt;</span> s) {</span>
<span id="cb45-15"><a href="#cb45-15"></a>            split[[i]] <span class="ot">&lt;-</span> new.v</span>
<span id="cb45-16"><a href="#cb45-16"></a>            <span class="fu">names</span>(split[[i]]) <span class="ot">&lt;-</span> <span class="fu">which</span>(u[, i] <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb45-17"><a href="#cb45-17"></a>            }</span>
<span id="cb45-18"><a href="#cb45-18"></a>         <span class="cf">else</span> <span class="cf">if</span> (delta.Q[i] <span class="sc">&lt;=</span> s) {</span>
<span id="cb45-19"><a href="#cb45-19"></a>            split[[i]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-20"><a href="#cb45-20"></a>            }</span>
<span id="cb45-21"><a href="#cb45-21"></a>      }</span>
<span id="cb45-22"><a href="#cb45-22"></a>   <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">delta.Q =</span> <span class="fu">round</span>(delta.Q, <span class="dv">3</span>), <span class="at">v =</span> v, <span class="at">split =</span> split))</span>
<span id="cb45-23"><a href="#cb45-23"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function uses the output of the <code>split.two</code> function to check if any of the two sub-communities should be split in two further ones by comparing the modularities pre and post second partition.</p>
<p>Here are the results applied to the <code>law_friends</code> network:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>   s <span class="ot">&lt;-</span> <span class="fu">split.mult</span>(<span class="at">B =</span> Bu, </span>
<span id="cb46-2"><a href="#cb46-2"></a>                   <span class="at">vol =</span> <span class="fu">sum</span>(<span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(ug))), </span>
<span id="cb46-3"><a href="#cb46-3"></a>                   <span class="at">u =</span> <span class="fu">split.two</span>(Bu)<span class="sc">$</span>dummy, </span>
<span id="cb46-4"><a href="#cb46-4"></a>                   <span class="at">v =</span> <span class="fu">split.two</span>(Bu)<span class="sc">$</span>v)</span>
<span id="cb46-5"><a href="#cb46-5"></a>   s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$delta.Q
[1] 0.000 0.048

$v
 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  1  1  1  2  2  1  1  1  1  1  1  1  1  1  1  2  1  1  1  1  1  1  1  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  2  1  1  2  2  2  1  2  2  1  2  1  2  2  1  2  2  2  2  2  2  2  2  2  2 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
 2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 

$split
$split[[1]]
NULL

$split[[2]]
 6  7 18 28 31 32 33 35 36 38 40 41 43 44 45 46 47 48 49 50 51 52 53 54 55 56 
 2  2  2  2  2  2  2  2  2  1  1  1  1  1  1  1  2  2  1  1  1  1  1  1  2  2 
57 58 59 60 61 62 63 64 65 66 67 68 
 2  1  1  2  1  1  1  1  1  1  1  1 </code></pre>
</div>
</div>
<p>The <code>delta.Q</code> vector stores the results of our modularity checks. In this case, the test in the first community failed; the modularity didn’t change (the difference between the old and the new is zero) when we tried to split into two smaller communities. This is usually indicative that the original community was a well-defined <strong>group</strong> with lots of within-cluster ties so that splitting it makes no difference (that’s the orange nodes in the figure above).</p>
<p>Nevertheless, the test in the second community returned a positive result, indicating we should split it in two. Because we left one of the original communities alone, the resulting network will have three communities after splitting the second one in two.</p>
<p>Note that the function returns the original two-split named vector of communities assignments <code>v</code>, a <code>NULL</code> result for the first split, and a new vector assigning nodes in the second original split to two other communities (<code>split[[2]]</code>).</p>
<p>We now create a new three-community vector from these results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>   s<span class="sc">$</span>v[<span class="fu">names</span>(s<span class="sc">$</span>split[[<span class="dv">2</span>]])] <span class="ot">&lt;-</span> s<span class="sc">$</span>split[[<span class="dv">2</span>]] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>   s<span class="sc">$</span>v</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  1  1  1  3  3  1  1  1  1  1  1  1  1  1  1  3  1  1  1  1  1  1  1  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  3  1  1  3  3  3  1  3  3  1  2  1  2  2  1  2  2  2  2  3  3  2  2  2  2 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
 2  2  3  3  3  2  2  3  2  2  2  2  2  2  2  2 </code></pre>
</div>
</div>
<p>And visualize them as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>   <span class="fu">V</span>(ug)<span class="sc">$</span>color <span class="ot">&lt;-</span> s<span class="sc">$</span>v</span>
<span id="cb50-2"><a href="#cb50-2"></a>   <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb50-3"><a href="#cb50-3"></a>   <span class="fu">plot</span>(ug, </span>
<span id="cb50-4"><a href="#cb50-4"></a>     <span class="at">vertex.size=</span><span class="dv">6</span>, <span class="at">vertex.frame.color=</span><span class="st">"lightgray"</span>, </span>
<span id="cb50-5"><a href="#cb50-5"></a>     <span class="at">vertex.label =</span> <span class="cn">NA</span>, <span class="at">edge.arrow.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb50-6"><a href="#cb50-6"></a>     <span class="at">vertex.label.dist=</span><span class="dv">1</span>, <span class="at">edge.curved=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="handout6_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Law Firm Friendship Network by The Best Three-Community Partition Using the Leading Eigenvector of the Modularity Matrix Approach</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Which shows the new three-community partition.</p>
<p>Now let’s say we wanted to check if we should <em>further</em> split any of these three communities into two. All we need to do is create “dummy” variables for the new three community partition and feed these (and the three community membership vector) to the <code>split.mult</code> function, while keeping <em>the original</em> modularity matrix <span class="citation" data-cites="newman06">(<a href="#ref-newman06" role="doc-biblioref">Newman 2006</a>)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>   c1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(s<span class="sc">$</span>v))</span>
<span id="cb51-2"><a href="#cb51-2"></a>   c2 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(s<span class="sc">$</span>v))</span>
<span id="cb51-3"><a href="#cb51-3"></a>   c3 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(s<span class="sc">$</span>v))</span>
<span id="cb51-4"><a href="#cb51-4"></a>   c1[<span class="fu">which</span>(s<span class="sc">$</span>v<span class="sc">==</span><span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb51-5"><a href="#cb51-5"></a>   c2[<span class="fu">which</span>(s<span class="sc">$</span>v<span class="sc">==</span><span class="dv">2</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb51-6"><a href="#cb51-6"></a>   c3[<span class="fu">which</span>(s<span class="sc">$</span>v<span class="sc">==</span><span class="dv">3</span>)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb51-7"><a href="#cb51-7"></a>   dummies <span class="ot">&lt;-</span> <span class="fu">cbind</span>(c1, c2, c3)</span>
<span id="cb51-8"><a href="#cb51-8"></a>   s <span class="ot">&lt;-</span> <span class="fu">split.mult</span>(<span class="at">B =</span> Bu, </span>
<span id="cb51-9"><a href="#cb51-9"></a>                   <span class="at">vol =</span> <span class="fu">sum</span>(<span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(ug))), </span>
<span id="cb51-10"><a href="#cb51-10"></a>                   <span class="at">u =</span> dummies, </span>
<span id="cb51-11"><a href="#cb51-11"></a>                   <span class="at">v =</span> s<span class="sc">$</span>v)</span>
<span id="cb51-12"><a href="#cb51-12"></a>   s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$delta.Q
[1]  0.000  0.000 -0.002

$v
 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  1  1  1  3  3  1  1  1  1  1  1  1  1  1  1  3  1  1  1  1  1  1  1  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  3  1  1  3  3  3  1  3  3  1  2  1  2  2  1  2  2  2  2  3  3  2  2  2  2 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
 2  2  3  3  3  2  2  3  2  2  2  2  2  2  2  2 

$split
list()</code></pre>
</div>
</div>
<p>Here, the the three modularity split checks failed, as given by the <code>delta.Q</code> vector. So no further splits were made (hence the <code>split</code> object is an empty list). This tells us that according to this method, three communities is the optimal partition.</p>
<p>Of course, if you are working on your project, you don’t have to mess with all of the functions above, because <code>igraph</code> has implemented Newman’s leading eigenvector (of the modularity matrix) community detection method <span class="citation" data-cites="newman06">(<a href="#ref-newman06" role="doc-biblioref">Newman 2006</a>)</span> in a single function called <code>cluster_leading_eigevector</code>.</p>
<p>To use it, just feed it the relevant graph:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>   le.res <span class="ot">&lt;-</span> <span class="fu">cluster_leading_eigen</span>(ug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And examine the <code>membership</code> object stored in the results list:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>   <span class="fu">names</span>(le.res<span class="sc">$</span>membership) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(le.res<span class="sc">$</span>membership)</span>
<span id="cb54-2"><a href="#cb54-2"></a>   le.res<span class="sc">$</span>membership</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  1  1  1  2  2  1  1  1  1  1  1  1  1  1  1  2  1  1  1  1  1  1  1  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  2  1  1  2  2  2  1  2  2  1  3  1  3  3  1  3  2  3  3  2  2  3  3  3  3 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
 3  3  2  2  2  3  3  2  3  3  3  3  3  3  3  3 </code></pre>
</div>
</div>
<p>Which returns identical community assignments as above (but with the labels between communities 2 and 3 flipped).</p>
</section>
<section id="communities-versus-exogeneous-attributes" class="level2">
<h2 class="anchored" data-anchor-id="communities-versus-exogeneous-attributes">Communities versus Exogeneous Attributes</h2>
<p>Remember we began this handout using an exogenous criterion (law firm status as partner or associate) to examine the community structure of the network (which does pretty well according to the modularity). But now we have also used a pure link-based approach to finding communities. How do they compare? Here’s a way to find out:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>   <span class="fu">library</span>(kableExtra)</span>
<span id="cb56-2"><a href="#cb56-2"></a>   t <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">V</span>(ug)<span class="sc">$</span>status, le.res<span class="sc">$</span>membership)</span>
<span id="cb56-3"><a href="#cb56-3"></a>   <span class="fu">kbl</span>(t, <span class="at">row.names =</span> <span class="cn">TRUE</span>, <span class="at">align =</span> <span class="st">"c"</span>, <span class="at">format =</span> <span class="st">"html"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-4"><a href="#cb56-4"></a>      <span class="fu">column_spec</span>(<span class="dv">1</span>, <span class="at">bold =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb56-5"><a href="#cb56-5"></a>      <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-6"><a href="#cb56-6"></a>                     <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"hover"</span>, <span class="st">"condensed"</span>, <span class="st">"responsive"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> 1 </th>
   <th style="text-align:center;"> 2 </th>
   <th style="text-align:center;"> 3 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;font-weight: bold;"> 1 </td>
   <td style="text-align:center;"> 27 </td>
   <td style="text-align:center;"> 9 </td>
   <td style="text-align:center;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;font-weight: bold;"> 2 </td>
   <td style="text-align:center;"> 3 </td>
   <td style="text-align:center;"> 7 </td>
   <td style="text-align:center;"> 22 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>This is just a <strong>contingency table</strong> listing status in the rows (1 = partner) and the three leading eigenvector communities in the columns.</p>
<p>We find that community one (the most coherent; in orange) is composed of 89% of partners. So it is a high status clique. Community three (in blue) on the other hand is composed of 100% of associates, a less dense, but completely (low) status homogeneous clique. Finally community two (green) is a status-mixed clique, composed of nine partners and seven associates.</p>
<p>So in this network, both status and endogenous group dynamics seem to be at play.</p>
</section>
<section id="an-agglomerative-approach-based-on-the-modularity" class="level2">
<h2 class="anchored" data-anchor-id="an-agglomerative-approach-based-on-the-modularity">An Agglomerative Approach Based on the Modularity</h2>
<p>The leading eigenvector approach discussed above is a <strong>divisive</strong> clustering algorithm. All nodes begin in one community, then we split in two, then we try to split one of those two into two other ones (if the modularity increases) and so forth.</p>
<p>But as we noted in the previous handout, another way to cluster is <em>bottom up</em>. All nodes begin in their own singleton cluster, and we join nodes if they maximize some criterion, in this case, the modularity. We then join new nodes to that group if they increase the modularity, otherwise we try other joins, until we can’t increase the modularity any longer.</p>
<p>This <strong>agglomerative</strong> approach to clustering is not guaranteed to reach some kind of global maximum, but it can work in most applied settings even at the risk of getting stuck in a local optimum.</p>
<p><span class="citation" data-cites="newman04">Newman (<a href="#ref-newman04" role="doc-biblioref">2004</a>)</span> developed an agglomerative algorithm that optimizes the modularity, a more recent version of which is included in an <code>igraph</code> function called <code>cluster_fast_greedy</code> <span class="citation" data-cites="clauset_etal04">(<a href="#ref-clauset_etal04" role="doc-biblioref">Clauset, Newman, and Moore 2004</a>)</span>.</p>
<p>Let’s try it out to see how it works:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>   fg.res <span class="ot">&lt;-</span> <span class="fu">cluster_fast_greedy</span>(ug)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting list object has various sub-objects as components. One of them is called <code>merges</code> which gives a history of the various merges that resulted in the final communities. This means that we can view the results as a <strong>dendrogram</strong> just like we did with structural similarity analyses based on hierarchical clustering of a distance matrix.</p>
<p>To do this we just transform the resulting object into an <code>hclust</code> object and plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>   hc <span class="ot">&lt;-</span> <span class="fu">as.hclust</span>(fg.res)</span>
<span id="cb58-2"><a href="#cb58-2"></a>   <span class="fu">par</span>(<span class="at">cex =</span> <span class="fl">0.5</span>) <span class="co">#smaller labels</span></span>
<span id="cb58-3"><a href="#cb58-3"></a>   <span class="fu">plot</span>(hc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="handout6_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Which gives us the sense that the network is divided into three communities like we saw earlier. If wanted to see which nodes are in which, we could just cut the dendrogram at <span class="math inline">\(k = 3\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>   <span class="fu">library</span>(dendextend)</span>
<span id="cb59-2"><a href="#cb59-2"></a>   <span class="fu">cutree</span>(hc, <span class="at">k =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  2  1  2  2  2  1  1  1  1  1  1  2  1  1  1  2  1  1  1  1  1  1  2  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  2  1  2  2  2  2  1  2  2  1  3  1  3  3  3  3  3  3  3  2  2  3  1  3  3 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
 3  3  3  2  3  3  3  2  3  3  3  3  3  3  3  3 </code></pre>
</div>
</div>
<p>Which provides the relevant assignment to communities (if we wanted more communities, we would cut the tree at a lower height).</p>
<p>Of course, this information was already stored in our results in the <code>membership</code> object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>   <span class="fu">names</span>(fg.res<span class="sc">$</span>membership) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">68</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And visualizing the resulting three-community partition:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>   <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb62-2"><a href="#cb62-2"></a>   <span class="fu">V</span>(g)<span class="sc">$</span>color <span class="ot">&lt;-</span> fg.res<span class="sc">$</span>membership</span>
<span id="cb62-3"><a href="#cb62-3"></a>   <span class="fu">plot</span>(ug, </span>
<span id="cb62-4"><a href="#cb62-4"></a>     <span class="at">vertex.size=</span><span class="dv">6</span>, <span class="at">vertex.frame.color=</span><span class="st">"lightgray"</span>, </span>
<span id="cb62-5"><a href="#cb62-5"></a>     <span class="at">vertex.label =</span> <span class="cn">NA</span>, <span class="at">edge.arrow.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb62-6"><a href="#cb62-6"></a>     <span class="at">vertex.label.dist=</span><span class="dv">1</span>, <span class="at">edge.curved=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="handout6_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Law Firm Friendship Network Partitioned According to Agglomerative Clustering Based on Optimizing the Modularity</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Which is pretty close to what we got using the leading eigenvector method.</p>
</section>
<section id="community-detection-using-edge-betweenness" class="level2">
<h2 class="anchored" data-anchor-id="community-detection-using-edge-betweenness">Community Detection Using Edge Betweenness</h2>
<p>A final approach to community detection with good sociological bona fides relies on <strong>edge betweenness</strong>, a concept we covered on the centrality handout. And edge has high betweenness if many other pairs of nodes need to use to reach one another via shortest paths.</p>
<p>It follows that if we iteratively identify high betweenness edges, removing the top one, recalculate the edge betweenness on the resulting edge-deleted subgraph, and remove <em>that</em> top one (or flip a coin if two are tied) we have an algorithm for identifying communities as those subgraphs that end up being disconnected after removing the bridges <span class="citation" data-cites="girvan_newman02">(<a href="#ref-girvan_newman02" role="doc-biblioref">Girvan and Newman 2002</a>)</span>.</p>
<p>Note that like the leading eigenvector method, this approach is <strong>divisive</strong> with all nodes starting in a single cluster, then that cluster splitting in two, and so forth. This algorithm is implemented in <code>igraph</code> in the function <code>cluster_edge_betweenness</code>.</p>
<p>Let’s see how it works:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>   eb.res <span class="ot">&lt;-</span> <span class="fu">cluster_edge_betweenness</span>(ug, <span class="at">directed =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Interestingly, even though this is a divisive algorithm, the results can be presented as a dendrogram, but storing top down divisions rather than bottom up merges:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>   hc <span class="ot">&lt;-</span> <span class="fu">as.hclust</span>(eb.res)</span>
<span id="cb64-2"><a href="#cb64-2"></a>   <span class="fu">par</span>(<span class="at">cex =</span> <span class="fl">0.5</span>) <span class="co">#smaller labels</span></span>
<span id="cb64-3"><a href="#cb64-3"></a>   <span class="fu">plot</span>(hc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="handout6_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that the edge betweenness provides a different picture of the community structure of the network. This is not surprising because it is based on graph theoretic principles and not on null model principles like the modularity: The picture here is of two broad communities (in the middle) surrounded by many smaller islands, including some singletons.</p>
<p>We can, of course, combine the modularity and edge-betweenness criteria by trying out dendrogram cuts until we find one with the highest modularity.</p>
<p>A simple function that does that looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>   top.mod <span class="ot">&lt;-</span> <span class="cf">function</span>(x, g, m) {</span>
<span id="cb65-2"><a href="#cb65-2"></a>      k <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>m</span>
<span id="cb65-3"><a href="#cb65-3"></a>      Q <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, m)</span>
<span id="cb65-4"><a href="#cb65-4"></a>      tab <span class="ot">&lt;-</span> <span class="fu">cbind</span>(k, Q)</span>
<span id="cb65-5"><a href="#cb65-5"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>m) {</span>
<span id="cb65-6"><a href="#cb65-6"></a>         c <span class="ot">&lt;-</span> <span class="fu">cutree</span>(x, i)</span>
<span id="cb65-7"><a href="#cb65-7"></a>         tab[i, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">modularity</span>(g, c, <span class="at">directed =</span> <span class="cn">FALSE</span>), <span class="dv">3</span>)</span>
<span id="cb65-8"><a href="#cb65-8"></a>      }</span>
<span id="cb65-9"><a href="#cb65-9"></a>   <span class="fu">return</span>(tab)</span>
<span id="cb65-10"><a href="#cb65-10"></a>   }</span>
<span id="cb65-11"><a href="#cb65-11"></a>   <span class="fu">top.mod</span>(hc, ug, <span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       k     Q
 [1,]  1 0.000
 [2,]  2 0.000
 [3,]  3 0.067
 [4,]  4 0.069
 [5,]  5 0.073
 [6,]  6 0.073
 [7,]  7 0.072
 [8,]  8 0.071
 [9,]  9 0.070
[10,] 10 0.167
[11,] 11 0.166
[12,] 12 0.181
[13,] 13 0.178
[14,] 14 0.183
[15,] 15 0.179
[16,] 16 0.183
[17,] 17 0.182
[18,] 18 0.188
[19,] 19 0.193
[20,] 20 0.194
[21,] 21 0.192
[22,] 22 0.188
[23,] 23 0.208
[24,] 24 0.201
[25,] 25 0.195</code></pre>
</div>
</div>
<p>Which seems to recommend we divide the graph into 23 communities! This is, of course, what is stored in the <code>membership</code> object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a>   <span class="fu">names</span>(eb.res<span class="sc">$</span>membership) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">68</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>   eb.res<span class="sc">$</span>membership</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 
 1  1  2  1  3  4  2  1  1  1  1  1  1  5  6  1  1  3  7  1  1  1  1  1  1  1 
27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 
 1  3  1  8  1  3  3  1  3  1  1  1  1  1  1  1  9  7 10 11  3  3 12 13 14 15 
53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 
16 17  3 18  7 19 20 21 22  1 23 23 23 23 23 23 </code></pre>
</div>
</div>
<p>Another thing we can do with the <code>edge_betweenness</code> function output is that we can highlight the edges identified as <strong>bridges</strong> during the divisive process, as this information is stored in the object <code>bridges</code>. We can use this vector of edge ids to create an edge color vector that will highlight the bridges in red:</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>   <span class="fu">V</span>(ug)<span class="sc">$</span>color <span class="ot">&lt;-</span> c25[eb.res<span class="sc">$</span>membership]</span>
<span id="cb69-2"><a href="#cb69-2"></a>   e.col <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">"lightblue"</span>, <span class="fu">ecount</span>(ug))</span>
<span id="cb69-3"><a href="#cb69-3"></a>   e.col[eb.res<span class="sc">$</span>bridges] <span class="ot">&lt;-</span> <span class="st">"red"</span></span>
<span id="cb69-4"><a href="#cb69-4"></a>   <span class="fu">E</span>(ug)<span class="sc">$</span>color <span class="ot">&lt;-</span> e.col</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a>   <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb70-2"><a href="#cb70-2"></a>   <span class="fu">plot</span>(ug, </span>
<span id="cb70-3"><a href="#cb70-3"></a>     <span class="at">vertex.size=</span><span class="dv">6</span>, <span class="at">vertex.frame.color=</span><span class="st">"lightgray"</span>, </span>
<span id="cb70-4"><a href="#cb70-4"></a>     <span class="at">vertex.label =</span> <span class="cn">NA</span>, <span class="at">edge.arrow.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb70-5"><a href="#cb70-5"></a>     <span class="at">vertex.label.dist=</span><span class="dv">1</span>, <span class="at">edge.curved=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="handout6_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Law Firm Friendship Network Partitioned According to the Edge Betweenness Algorithm with Number of Communities that Maximize the Modularity (Bridge Edges in Red)</figcaption><p></p>
</figure>
</div>
</div>
</div>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-clauset_etal04" class="csl-entry" role="doc-biblioentry">
Clauset, Aaron, Mark EJ Newman, and Cristopher Moore. 2004. <span>“Finding Community Structure in Very Large Networks.”</span> <em>Physical Review E—Statistical, Nonlinear, and Soft Matter Physics</em> 70 (6): 066111.
</div>
<div id="ref-girvan_newman02" class="csl-entry" role="doc-biblioentry">
Girvan, Michelle, and Mark EJ Newman. 2002. <span>“Community Structure in Social and Biological Networks.”</span> <em>Proceedings of the National Academy of Sciences</em> 99 (12): 7821–26.
</div>
<div id="ref-newman04" class="csl-entry" role="doc-biblioentry">
Newman, Mark EJ. 2004. <span>“Fast Algorithm for Detecting Community Structure in Networks.”</span> <em>Physical Review E—Statistical, Nonlinear, and Soft Matter Physics</em> 69 (6): 066133.
</div>
<div id="ref-newman06" class="csl-entry" role="doc-biblioentry">
———. 2006. <span>“Finding Community Structure in Networks Using the Eigenvectors of Matrices.”</span> <em>Physical Review E—Statistical, Nonlinear, and Soft Matter Physics</em> 74 (3): 036104.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>