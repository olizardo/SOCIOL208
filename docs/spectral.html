<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SOCIOL 208 - Community Detection Using Spectral Clustering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="SOCIOL 208 - Community Detection Using Spectral Clustering">
<meta property="og:description" content="In the handout on communities, we saw how to use the leading (first) eigenvector of the modularity matrix to split a network in two (and then split those partitions in two and so on).">
<meta property="og:site-name" content="SOCIOL 208">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Community Detection Using Spectral Clustering</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">SOCIOL 208</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Home</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">208A</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllabus-208A.html" class="sidebar-item-text sidebar-link">208A Syllabus</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./schedule-208A-F24.html" class="sidebar-item-text sidebar-link">SOCIOL 208A Reading Schedule (Fall 2024)</a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Lecture Notes</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basic.html" class="sidebar-item-text sidebar-link">Basic Network Statistics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ego.html" class="sidebar-item-text sidebar-link">Analyzing Ego Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./eigen.html" class="sidebar-item-text sidebar-link">The Eigendecomposition of a Square Matrix</a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">Centrality and Prestige</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./centrality.html" class="sidebar-item-text sidebar-link">Centrality</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cube.html" class="sidebar-item-text sidebar-link">The Centrality Cube</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prestige.html" class="sidebar-item-text sidebar-link">Status and Prestige</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">Equivalence and Similarity</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./structequiv.html" class="sidebar-item-text sidebar-link">Role Equivalence and Structural Similarity</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./similarity.html" class="sidebar-item-text sidebar-link">Vertex Similarity</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./random-walk.html" class="sidebar-item-text sidebar-link">Random Walk Concepts in Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./blondel.html" class="sidebar-item-text sidebar-link">Role Similarity Across Graphs</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ahn.html" class="sidebar-item-text sidebar-link">Assigning Nodes to Multiple Communities</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Communities and Clustering</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth3 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./community.html" class="sidebar-item-text sidebar-link">Community Structure</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spectral.html" class="sidebar-item-text sidebar-link active">Community Detection Using Spectral Clustering</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">Two-Mode Networks</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tm-basic.html" class="sidebar-item-text sidebar-link">Analyzing Two-Mode Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tm-centrality.html" class="sidebar-item-text sidebar-link">Centrality in Two-Mode Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tm-duality.html" class="sidebar-item-text sidebar-link">The Duality of Persons and Groups</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tm-similarity.html" class="sidebar-item-text sidebar-link">Similarity and Equivalence in Two-Mode Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tm-ca.html" class="sidebar-item-text sidebar-link">Correspondence Analysis (CA) of Two-Mode Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tm-null.html" class="sidebar-item-text sidebar-link">Graph Ensembles in Two-Mode Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./backbone.html" class="sidebar-item-text sidebar-link">Extracting the Backbone of Bipartite Projections Using Two-Mode Graph Ensembles</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">Statistical Models</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./swap.html" class="sidebar-item-text sidebar-link">Graph Ensembles in Networks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qap.html" class="sidebar-item-text sidebar-link">Network Regression Using Permutation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ergm1.html" class="sidebar-item-text sidebar-link">Exponential Random Graphs Models I</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ergm2.html" class="sidebar-item-text sidebar-link">Exponential Random Graphs Models II</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false">Data Management</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./loading.html" class="sidebar-item-text sidebar-link">Loading Network Data from a File</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./network-lists.html" class="sidebar-item-text sidebar-link">Handling Graph Objects in Lists</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./subgraph-select.html" class="sidebar-item-text sidebar-link">Selecting a Subgraph Based on Edge Conditions</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">208B</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllabus-208B.html" class="sidebar-item-text sidebar-link">208B Syllabus</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./schedule-208B-S24.html" class="sidebar-item-text sidebar-link">SOCIOL 208B Reading Schedule (Spring 2024)</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#spectral-clustering" id="toc-spectral-clustering" class="nav-link active" data-scroll-target="#spectral-clustering">Spectral Clustering</a></li>
  <li><a href="#spectral-clustering-using-the-eigenvectors-of-the-laplacian" id="toc-spectral-clustering-using-the-eigenvectors-of-the-laplacian" class="nav-link" data-scroll-target="#spectral-clustering-using-the-eigenvectors-of-the-laplacian">Spectral Clustering Using the Eigenvectors of the Laplacian</a></li>
  <li><a href="#spectral-clustering-using-the-eigenvectors-of-the-normalized-laplacian" id="toc-spectral-clustering-using-the-eigenvectors-of-the-normalized-laplacian" class="nav-link" data-scroll-target="#spectral-clustering-using-the-eigenvectors-of-the-normalized-laplacian">Spectral Clustering Using the Eigenvectors of the <em>Normalized</em> Laplacian</a></li>
  <li><a href="#spectral-clustering-using-the-eigenvectors-of-the-degree-normalized-laplacian" id="toc-spectral-clustering-using-the-eigenvectors-of-the-degree-normalized-laplacian" class="nav-link" data-scroll-target="#spectral-clustering-using-the-eigenvectors-of-the-degree-normalized-laplacian">Spectral Clustering Using the Eigenvectors of the <em>Degree-Normalized</em> Laplacian</a></li>
  <li><a href="#clustering-using-the-eigenvectors-of-the-modularity-matrix" id="toc-clustering-using-the-eigenvectors-of-the-modularity-matrix" class="nav-link" data-scroll-target="#clustering-using-the-eigenvectors-of-the-modularity-matrix">Clustering Using the Eigenvectors of the Modularity Matrix</a></li>
  <li><a href="#spectral-clustering-of-two-mode-networks" id="toc-spectral-clustering-of-two-mode-networks" class="nav-link" data-scroll-target="#spectral-clustering-of-two-mode-networks">Spectral Clustering of Two-Mode Networks</a></li>
  <li><a href="#bipartite-modularity-allowing-people-and-groups-to-belong-to-different-number-of-communities" id="toc-bipartite-modularity-allowing-people-and-groups-to-belong-to-different-number-of-communities" class="nav-link" data-scroll-target="#bipartite-modularity-allowing-people-and-groups-to-belong-to-different-number-of-communities">Bipartite Modularity Allowing People and Groups to Belong to Different Number of Communities</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/olizardo/SOCIOL208/blob/main/spectral.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Community Detection Using Spectral Clustering</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="spectral-clustering" class="level2">
<h2 class="anchored" data-anchor-id="spectral-clustering">Spectral Clustering</h2>
<p>In the handout on communities, we saw how to use the leading (first) eigenvector of the modularity matrix to split a network in two (and then split those partitions in two and so on).</p>
<p>In the handout on CA, we saw that the eigendecomposition of a square matrix actually results in <span class="math inline">\(p\)</span> eigenvectors and eigenvalues (not just the leading or first).</p>
<p>We also learned from the eigendecomposition lesson that selecting some number <span class="math inline">\(k &lt; p\)</span> of eigenvectors and eigenvalues helps us reconstruct the best approximation of the original matrix given that number of dimensions.</p>
<p>Putting these three lessons together suggests a simple way to detect multiple communities in a network using the eigenvalues of a suitable matrix, along with standard clustering algorithms such as k-means clustering. This approach does not have to iterate between binary divisions based on a single (leading) eigenvector, but can instead use multiple eigenvectors at once to partition the data into any desired number of clusters.</p>
<p>This general approach to community detection is sometimes referred to as <strong>spectral clustering</strong>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</section>
<section id="spectral-clustering-using-the-eigenvectors-of-the-laplacian" class="level2">
<h2 class="anchored" data-anchor-id="spectral-clustering-using-the-eigenvectors-of-the-laplacian">Spectral Clustering Using the Eigenvectors of the Laplacian</h2>
<p>The issue then becomes, <em>which</em> matrix should we use the eigenvalues and eigenvectors of? As suggested by <span class="citation" data-cites="vonluxburg07">Von Luxburg (<a href="#ref-vonluxburg07" role="doc-biblioref">2007</a>)</span>, an obvious candidate is what is called the <strong>graph Laplacian</strong> (<span class="math inline">\(\mathbf{L}\)</span>), which is given by:</p>
<p><span class="math display">\[
\mathbf{L} = \mathbf{D} - \mathbf{A}
\]</span></p>
<p>Where <span class="math inline">\(\mathbf{D}\)</span> is the graph’s <strong>degree matrix</strong> a matrix with the degree vector of the graph along the diagonals and zeros everywhere else.</p>
<p>Like the modularity matrix, the <span class="math inline">\(\mathbf{L}\)</span> matrix is doubly-centered (rows and columns sum to zero), which means, via some math other smarter people have worked out, that, if <span class="math inline">\(\mathbf{A}\)</span> is connected, one of the eigenvalues of <span class="math inline">\(\mathbf{L}\)</span> is guaranteed to be zero.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>The other interesting thing is that the second smallest (non-zero) eigenvalue of <span class="math inline">\(\mathbf{L}\)</span> (sometimes called the <strong>Fiedler vector</strong>) provides an optimal (e.g., minimizing the number of cross-community edges) two-community partition of the graph (just like we saw the leading eigenvector of the modularity matrix does).</p>
<p>If we want to check for the existence of multiple groups, therefore, what we need to do is to create a new <span class="math inline">\(n \times k\)</span> matrix <span class="math inline">\(\mathbf{U}\)</span> composed of the <span class="math inline">\(k\)</span> eigenvectors of <span class="math inline">\(\mathbf{L}\)</span> associated with the <span class="math inline">\(k\)</span> <em>smallest</em> eigenvalues, arranged from smallest to biggest.</p>
<p>We then normalize the node-specific row-vector of values of the<span class="math inline">\(\mathbf{U}\)</span> matrix (e.g., using the Euclidean norm), and the use normalized <span class="math inline">\(\mathbf{U}\)</span> matrix, which is an embedding of the node set of the graph in an k-dimensional Euclidean space, as input to a k-means algorithm with a known number of clusters <span class="citation" data-cites="fouss_etal16">(<a href="#ref-fouss_etal16" role="doc-biblioref">Fouss, Saerens, and Shimbo 2016, 320</a>)</span>.</p>
<p>Let’s see how that would work. Let’s load the <code>law_friends</code> data from the <code>networkdata</code> package containing information on the friendship nominations of 68 lawyers in a firm. We have already analyzed these data using other community detection algorithms in a previous handout. The original data are directed, so we constrain them to be undirected and remove nodes with degree less than two:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>   <span class="fu">library</span>(networkdata)</span>
<span id="cb1-2"><a href="#cb1-2"></a>   <span class="fu">library</span>(igraph)</span>
<span id="cb1-3"><a href="#cb1-3"></a>   g <span class="ot">&lt;-</span> law_friends</span>
<span id="cb1-4"><a href="#cb1-4"></a>   g <span class="ot">&lt;-</span> <span class="fu">as_undirected</span>(g, <span class="at">mode =</span> <span class="st">"collapse"</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a>   g <span class="ot">&lt;-</span> <span class="fu">subgraph</span>(g, <span class="fu">degree</span>(g)<span class="sc">&gt;=</span><span class="dv">2</span>) <span class="co">#removing low degree nodes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then write a function called <code>ratio.cut</code> that accomplishes the eigendecomposition of the graph Laplacian matrix described earlier. It looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>   ratio.cut <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">k =</span> <span class="dv">6</span>) {</span>
<span id="cb2-2"><a href="#cb2-2"></a>         A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(x))</span>
<span id="cb2-3"><a href="#cb2-3"></a>         D <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">degree</span>(x))</span>
<span id="cb2-4"><a href="#cb2-4"></a>         n <span class="ot">&lt;-</span> <span class="fu">vcount</span>(x)</span>
<span id="cb2-5"><a href="#cb2-5"></a>         L <span class="ot">&lt;-</span> D <span class="sc">-</span> A</span>
<span id="cb2-6"><a href="#cb2-6"></a>         eig.L <span class="ot">&lt;-</span> <span class="fu">eigen</span>(L)</span>
<span id="cb2-7"><a href="#cb2-7"></a>         b <span class="ot">&lt;-</span> n <span class="sc">-</span> k</span>
<span id="cb2-8"><a href="#cb2-8"></a>         e <span class="ot">&lt;-</span> n <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>         U <span class="ot">&lt;-</span> <span class="fu">matrix</span>(eig.L<span class="sc">$</span>vectors[, b<span class="sc">:</span>e], <span class="at">nrow =</span> n, <span class="at">ncol =</span> k)</span>
<span id="cb2-10"><a href="#cb2-10"></a>         <span class="cf">if</span> (k <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb2-11"><a href="#cb2-11"></a>            U <span class="ot">&lt;-</span> U[, k<span class="sc">:</span><span class="dv">1</span>] <span class="co">#re-ordering columns from smallest to biggest</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>            }</span>
<span id="cb2-13"><a href="#cb2-13"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(U)) {</span>
<span id="cb2-14"><a href="#cb2-14"></a>            U[i, ] <span class="ot">&lt;-</span> U[i, ]<span class="sc">/</span><span class="fu">norm</span>(<span class="fu">as.matrix</span>(U[i, ]), <span class="at">type =</span> <span class="st">"E"</span>)</span>
<span id="cb2-15"><a href="#cb2-15"></a>            }</span>
<span id="cb2-16"><a href="#cb2-16"></a>      <span class="fu">return</span>(U)</span>
<span id="cb2-17"><a href="#cb2-17"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function takes a graph as input and produces the <span class="math inline">\(\mathbf{U}\)</span> matrix with <span class="math inline">\(n\)</span> rows and <span class="math inline">\(k\)</span> columns, with <span class="math inline">\(k=6\)</span> by default. It first computes the adjacency matrix (line 2), then the degree matrix (line 3), then the Laplacian matrix (line 5). It then computes the eigendecomposition of the Laplacian (line 6), row normalizes the values taken by the eigenvectors corresponding to the <span class="math inline">\(k\)</span> smallest eigenvalues in lines 10-13 (reverse-ordered from smallest to biggest in line 9), and returns the resulting matrix <span class="math inline">\(\mathbf{U}\)</span> in line 14.</p>
<p>Let’s see the function at work:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>   U <span class="ot">&lt;-</span> <span class="fu">ratio.cut</span>(g)</span>
<span id="cb3-2"><a href="#cb3-2"></a>   <span class="fu">round</span>(U, <span class="dv">2</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]
 [1,]  0.08  0.34  0.66  0.37 -0.54  0.13
 [2,]  0.07  0.29  0.60  0.37 -0.53  0.37
 [3,]  0.47  0.13  0.08 -0.87  0.03  0.04
 [4,]  0.34  0.38  0.71  0.16 -0.45  0.10
 [5,]  0.57  0.26  0.06 -0.78  0.00  0.01
 [6,]  0.58 -0.76 -0.21  0.20 -0.05  0.03
 [7,]  0.37  0.20 -0.01 -0.90  0.08  0.03
 [8,] -0.02  0.33  0.65  0.41 -0.55 -0.01
 [9,]  0.14  0.37  0.67  0.36 -0.52  0.04
[10,]  0.05  0.36  0.66  0.42 -0.50  0.06</code></pre>
</div>
</div>
<p>Which shows the corresponding values of <span class="math inline">\(\mathbf{U}\)</span> for each node across the six eigenvectors of the Laplacian we selected.</p>
<p>Now, the basic idea is to treat each of the normalized scores along the six eigenvectors as if they were “variables” or “features” in a standard k-means clustering problem. The algorithm will then group nodes based on how similar their scores are on each six-dimensional vector. Similar nodes will correspond to communities (k-means clusters) in our data.</p>
<p>K-means clustering requires knowing how many groups we want in advance (differently from hierarchical clustering). Since we don’t know which is the best community partition beforehand, we instead compute a bunch of partitions and check the modularity of each.</p>
<p>The following function computes cluster assignments of the nodes in the graph up to ten partitions (starting from the minimum two):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>   k.cuts <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">max =</span> <span class="dv">9</span>) {</span>
<span id="cb5-2"><a href="#cb5-2"></a>      clus <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-3"><a href="#cb5-3"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>max) {</span>
<span id="cb5-4"><a href="#cb5-4"></a>         <span class="fu">set.seed</span>(<span class="dv">456</span>) <span class="co">#setting seed because kmeans uses random starting nodes for cluster centroids</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>         k <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>         clus[[i]] <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(x, k)<span class="sc">$</span>cluster</span>
<span id="cb5-7"><a href="#cb5-7"></a>         }</span>
<span id="cb5-8"><a href="#cb5-8"></a>      <span class="fu">return</span>(clus)</span>
<span id="cb5-9"><a href="#cb5-9"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function takes the <span class="math inline">\(\mathbf{U}\)</span> matrix as input and returns a nine-element list (with vectors of length <span class="math inline">\(n\)</span> as its elements) of cluster assignments for each node in the graph, corresponding to partitions <span class="math inline">\(k = \{2, 3, \ldots 10\}\)</span> respectively.</p>
<p>Let’s see the clustering function at work:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>   clus <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(U)</span>
<span id="cb6-2"><a href="#cb6-2"></a>   clus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
 [1] 2 2 1 2 1 1 1 2 2 2 2 2 2 1 2 2 2 1 1 2 2 2 2 2 2 2 2 1 2 2 1 1 1 2 1 2 2 2
[39] 2 1 1 2 1 1 2 1 1 1 1 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1

[[2]]
 [1] 3 3 1 3 1 1 1 3 3 3 3 3 3 1 3 3 3 1 1 3 3 3 3 3 3 3 3 1 3 3 1 1 1 3 1 3 3 3
[39] 3 2 2 3 2 1 3 2 1 1 2 3 2 2 2 2 1 1 1 1 2 1 2 2 2 2 2 2 2 2

[[3]]
 [1] 3 3 4 3 4 4 4 3 3 3 3 3 3 4 3 3 3 4 1 3 3 3 3 3 3 3 3 4 3 3 4 4 4 3 1 3 3 3
[39] 3 2 2 3 2 1 3 2 1 1 2 3 2 2 2 1 1 1 1 1 2 4 2 2 2 2 2 2 2 2

[[4]]
 [1] 3 3 5 3 5 5 5 3 3 3 3 3 3 5 3 3 3 5 1 3 3 3 3 3 3 3 3 5 3 4 4 4 4 3 1 3 3 3
[39] 3 2 2 3 2 1 3 2 1 1 2 3 2 2 2 1 1 1 1 1 2 4 2 2 2 2 2 2 2 2

[[5]]
 [1] 3 3 5 3 5 5 5 3 3 3 3 3 3 5 3 3 3 5 1 3 3 3 3 3 4 3 3 5 3 4 6 6 6 3 1 4 3 3
[39] 3 2 2 3 2 1 3 2 1 1 2 3 2 2 2 1 1 1 1 1 2 6 2 2 2 2 2 2 2 2

[[6]]
 [1] 3 3 5 3 5 5 5 3 3 3 3 3 3 5 3 3 3 5 1 3 3 3 3 3 4 3 3 5 3 4 6 6 6 3 1 4 3 3
[39] 3 2 2 3 2 1 3 2 1 1 2 3 2 2 2 1 1 1 1 1 2 6 7 2 7 7 7 7 7 7

[[7]]
 [1] 8 8 5 8 5 5 5 8 8 8 8 8 8 5 8 8 8 5 1 8 8 8 8 8 4 8 8 5 8 4 6 6 6 3 1 3 3 3
[39] 3 2 2 3 2 1 3 2 1 1 2 8 2 2 2 1 1 1 1 1 2 6 7 2 7 7 7 7 7 7

[[8]]
 [1] 8 8 5 8 5 5 5 8 8 8 8 8 8 5 8 8 8 5 1 8 8 8 8 8 4 8 8 5 8 4 6 6 6 3 1 3 3 3
[39] 3 2 2 3 7 1 3 2 1 1 2 8 2 2 2 7 1 1 1 1 7 6 7 2 9 9 9 9 9 9

[[9]]
 [1]  3  3  5  3  5  5  5  3  3  3  3  3  3  5  8  3  3  5  1  3  3  3  3  3  4
[26]  3  3  5  3  4  6  6  6 10  1 10 10 10 10  2  2 10  7  1 10  2  1  1  2  8
[51]  2  2  2  7  1  1  1  1  7  6  7  2  9  9  9  9  9  9</code></pre>
</div>
</div>
<p>Great! Now that we have our partitions, we need to check the modularity corresponding to each one of them.</p>
<p>We can do this with the following quick function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>   mod.check <span class="ot">&lt;-</span> <span class="cf">function</span>(x, c) {</span>
<span id="cb8-2"><a href="#cb8-2"></a>      k <span class="ot">&lt;-</span> <span class="fu">length</span>(c)</span>
<span id="cb8-3"><a href="#cb8-3"></a>      m <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, k)</span>
<span id="cb8-4"><a href="#cb8-4"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k) {</span>
<span id="cb8-5"><a href="#cb8-5"></a>         m[i] <span class="ot">&lt;-</span> <span class="fu">modularity</span>(x, c[[i]])</span>
<span id="cb8-6"><a href="#cb8-6"></a>         }</span>
<span id="cb8-7"><a href="#cb8-7"></a>      <span class="fu">names</span>(m) <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">:</span>(k<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb8-8"><a href="#cb8-8"></a>      <span class="fu">return</span>(m)</span>
<span id="cb8-9"><a href="#cb8-9"></a>      }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which takes an <code>igraph</code> graph object and the list of cluster assignments as input and produces a vector of the same length as the list of cluster assignments with the modularity corresponding to that assignment.</p>
<p>Let’s see this function at work in our running example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>   mod.res <span class="ot">&lt;-</span> <span class="fu">mod.check</span>(g, clus)</span>
<span id="cb9-2"><a href="#cb9-2"></a>   <span class="fu">round</span>(mod.res, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2     3     4     5     6     7     8     9    10 
0.305 0.356 0.328 0.319 0.316 0.300 0.302 0.293 0.286 </code></pre>
</div>
</div>
<p>Which suggests that the three-cluster partition of the network (shown in <a href="#fig-friends-2">Figure&nbsp;1 (b)</a>) does pretty well in separating densely connected subgraphs (<span class="math inline">\(Q = 0.36\)</span>).</p>
<p>Note that this partition looks a lot like the one we settled on using Newman’s divisive leading eigenvector approach based on the modularity matrix: One core dense group of lawyers surrounded by a looser couple of communities.</p>
<div id="fig-friends" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends-1.png" class="img-fluid figure-img" data-ref-parent="fig-friends" width="1152"></p>
<p></p><figcaption class="figure-caption">(a) Original Network</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends-2.png" class="img-fluid figure-img" data-ref-parent="fig-friends" width="1152"></p>
<p></p><figcaption class="figure-caption">(b) Maximum Modularity Solution)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends-3.png" class="img-fluid figure-img" data-ref-parent="fig-friends" width="1152"></p>
<p></p><figcaption class="figure-caption">(c) Four Community Solution</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends-4.png" class="img-fluid figure-img" data-ref-parent="fig-friends" width="1152"></p>
<p></p><figcaption class="figure-caption">(d) Five Community Solution</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends-5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends-5.png" class="img-fluid figure-img" data-ref-parent="fig-friends" width="1152"></p>
<p></p><figcaption class="figure-caption">(e) Six Community Solution</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends-6" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends-6.png" class="img-fluid figure-img" data-ref-parent="fig-friends" width="1152"></p>
<p></p><figcaption class="figure-caption">(f) Seven Community Solution</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Clustering of Nodes in the Law Firm Friendship Network Using the Ratio Cut</figcaption><p></p>
</figure>
</div>
<p>Note also that the four, five, six and even seven-community partitions are not too shabby either. We can see those in <a href="#fig-friends-3">Figure&nbsp;1 (c)</a>-<a href="#fig-friends-6">Figure&nbsp;1 (f)</a> as they reveal further insights into the group structure of the network beyond the main three-community division.</p>
<p>Note that further subdivisions of the network split the more loosely structured community in the upper-right, while the more densely linked community in the lower-left remains largely undisturbed.</p>
</section>
<section id="spectral-clustering-using-the-eigenvectors-of-the-normalized-laplacian" class="level2">
<h2 class="anchored" data-anchor-id="spectral-clustering-using-the-eigenvectors-of-the-normalized-laplacian">Spectral Clustering Using the Eigenvectors of the <em>Normalized</em> Laplacian</h2>
<p>We saw how to cluster a network in a way that results in a good community partition using the Laplacian of the adjacency matrix <span class="math inline">\(\mathbf{L}\)</span>. Another approach is to use a (degree) normalized version of the same matrix <span class="math inline">\(\mathbf{\hat{L}}\)</span>, defined as follows:</p>
<p><span class="math display">\[
\mathbf{\hat{L}} = \mathbf{I} - \mathbf{D}^{-\frac{1}{2}}\mathbf{A}\mathbf{D}^{-\frac{1}{2}}
\]</span></p>
<p>Where everything else is as before and <span class="math inline">\(\mathbf{I}\)</span> is the identity matrix (an <span class="math inline">\(n \times n\)</span> matrix with ones along the diagonals and zero everywhere else), and <span class="math inline">\(\mathbf{D}^{-\frac{1}{2}}\)</span> is a matrix containing the inverse of the square root of degrees of each node (<span class="math inline">\(1/\sqrt{k_i}\)</span>) in the diagonals and zeros everywhere else.</p>
<p>We can just adapt our previous <code>ratio.cut</code> function code to perform this new job:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>   norm.ratio.cut <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">k =</span> <span class="dv">6</span>) {</span>
<span id="cb11-2"><a href="#cb11-2"></a>         A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(x))</span>
<span id="cb11-3"><a href="#cb11-3"></a>         n <span class="ot">&lt;-</span> <span class="fu">vcount</span>(x)</span>
<span id="cb11-4"><a href="#cb11-4"></a>         I <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span>, n, n)</span>
<span id="cb11-5"><a href="#cb11-5"></a>         D <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">degree</span>(x)))</span>
<span id="cb11-6"><a href="#cb11-6"></a>         L <span class="ot">&lt;-</span> I <span class="sc">-</span> (D <span class="sc">%*%</span> A <span class="sc">%*%</span> D)</span>
<span id="cb11-7"><a href="#cb11-7"></a>         eig.L <span class="ot">&lt;-</span> <span class="fu">eigen</span>(L)</span>
<span id="cb11-8"><a href="#cb11-8"></a>         b <span class="ot">&lt;-</span> n <span class="sc">-</span> k</span>
<span id="cb11-9"><a href="#cb11-9"></a>         e <span class="ot">&lt;-</span> n <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>         U <span class="ot">&lt;-</span> <span class="fu">matrix</span>(eig.L<span class="sc">$</span>vectors[, b<span class="sc">:</span>e], <span class="at">nrow =</span> n, <span class="at">ncol =</span> k)</span>
<span id="cb11-11"><a href="#cb11-11"></a>         <span class="cf">if</span> (k <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb11-12"><a href="#cb11-12"></a>            U <span class="ot">&lt;-</span> U[, k<span class="sc">:</span><span class="dv">1</span>] <span class="co">#re-ordering columns from smallest to biggest</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>            }         </span>
<span id="cb11-14"><a href="#cb11-14"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(U)) {</span>
<span id="cb11-15"><a href="#cb11-15"></a>            U[i, ] <span class="ot">&lt;-</span> U[i, ]<span class="sc">/</span><span class="fu">norm</span>(<span class="fu">as.matrix</span>(U[i, ]), <span class="at">type =</span> <span class="st">"E"</span>)</span>
<span id="cb11-16"><a href="#cb11-16"></a>            }</span>
<span id="cb11-17"><a href="#cb11-17"></a>      <span class="fu">return</span>(U)</span>
<span id="cb11-18"><a href="#cb11-18"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Where we just have to modify the way we define the <span class="math inline">\(\mathbf{D}\)</span> and <span class="math inline">\(\mathbf{L}\)</span> matrices in lines 5 and 6 respectively, after creating the <span class="math inline">\(\mathbf{I}\)</span> matrix in line 4.</p>
<p>Now let’s see if the normalized cut can help us finds some communities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>   U <span class="ot">&lt;-</span> <span class="fu">norm.ratio.cut</span>(g)</span>
<span id="cb12-2"><a href="#cb12-2"></a>   clus <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(U)</span>
<span id="cb12-3"><a href="#cb12-3"></a>   mod.res <span class="ot">&lt;-</span> <span class="fu">mod.check</span>(g, clus)</span>
<span id="cb12-4"><a href="#cb12-4"></a>   <span class="fu">round</span>(mod.res, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2     3     4     5     6     7     8     9    10 
0.250 0.316 0.320 0.352 0.350 0.331 0.293 0.284 0.246 </code></pre>
</div>
</div>
<div id="fig-friends2" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends2-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends2-1.png" class="img-fluid figure-img" data-ref-parent="fig-friends2" width="1152"></p>
<p></p><figcaption class="figure-caption">(a) Five Community Solution</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends2-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends2-2.png" class="img-fluid figure-img" data-ref-parent="fig-friends2" width="1152"></p>
<p></p><figcaption class="figure-caption">(b) Six Community Solution</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: Clustering of Nodes in the Law Firm Friendship Network Using the Normalized Ratio Cut</figcaption><p></p>
</figure>
</div>
<p>As we can see, the normalized ratio cut approach performs almost as well as the ratio cut approach in terms of the maximum modularity it finds (<span class="math inline">\(Q = 0.35\)</span>), but suggests a finer grained partition, with the maximum at either five or six communities.</p>
<p>The resulting node clusters are shown in <a href="#fig-friends2-1">Figure&nbsp;2 (a)</a> and <a href="#fig-friends2-2">Figure&nbsp;2 (b)</a>.</p>
</section>
<section id="spectral-clustering-using-the-eigenvectors-of-the-degree-normalized-laplacian" class="level2">
<h2 class="anchored" data-anchor-id="spectral-clustering-using-the-eigenvectors-of-the-degree-normalized-laplacian">Spectral Clustering Using the Eigenvectors of the <em>Degree-Normalized</em> Laplacian</h2>
<p>An alternative version of the normalized Laplacian is given by:</p>
<p><span class="math display">\[
\mathbf{\bar{L}} = \mathbf{D}^{-1}\mathbf{L}
\]</span></p>
<p>Which is just the original Laplacian as defined earlier with each entry divided by the degree of the corresponding node in that row.</p>
<p>A function that extracts the relevant eigenvectors of this version of the normalized Laplacian goes as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>   d.norm.ratio.cut <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">k =</span> <span class="dv">6</span>) {</span>
<span id="cb14-2"><a href="#cb14-2"></a>         A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(x))</span>
<span id="cb14-3"><a href="#cb14-3"></a>         n <span class="ot">&lt;-</span> <span class="fu">vcount</span>(x)</span>
<span id="cb14-4"><a href="#cb14-4"></a>         I <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">1</span>, n, n)</span>
<span id="cb14-5"><a href="#cb14-5"></a>         D <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">degree</span>(x))</span>
<span id="cb14-6"><a href="#cb14-6"></a>         L <span class="ot">&lt;-</span> <span class="fu">solve</span>(D) <span class="sc">%*%</span> (D <span class="sc">-</span> A)</span>
<span id="cb14-7"><a href="#cb14-7"></a>         eig.L <span class="ot">&lt;-</span> <span class="fu">eigen</span>(L)</span>
<span id="cb14-8"><a href="#cb14-8"></a>         b <span class="ot">&lt;-</span> n <span class="sc">-</span> k</span>
<span id="cb14-9"><a href="#cb14-9"></a>         e <span class="ot">&lt;-</span> n <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>         U <span class="ot">&lt;-</span> <span class="fu">matrix</span>(eig.L<span class="sc">$</span>vectors[, b<span class="sc">:</span>e], <span class="at">nrow =</span> n, <span class="at">ncol =</span> k)</span>
<span id="cb14-11"><a href="#cb14-11"></a>         <span class="cf">if</span> (k <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb14-12"><a href="#cb14-12"></a>            U <span class="ot">&lt;-</span> U[, k<span class="sc">:</span><span class="dv">1</span>] <span class="co">#re-ordering columns from smallest to biggest</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>            }         </span>
<span id="cb14-14"><a href="#cb14-14"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(U)) {</span>
<span id="cb14-15"><a href="#cb14-15"></a>            U[i, ] <span class="ot">&lt;-</span> U[i, ]<span class="sc">/</span><span class="fu">norm</span>(<span class="fu">as.matrix</span>(U[i, ]), <span class="at">type =</span> <span class="st">"E"</span>)</span>
<span id="cb14-16"><a href="#cb14-16"></a>            }</span>
<span id="cb14-17"><a href="#cb14-17"></a>      <span class="fu">return</span>(U)</span>
<span id="cb14-18"><a href="#cb14-18"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Where, once again, we only need to modify a couple of lines (5 and 6) from before to compute the new version of <span class="math inline">\(\mathbf{L}\)</span>.</p>
<p>To see the quality of the partitions obtained via this method, we just type:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>   clus <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(<span class="fu">d.norm.ratio.cut</span>(g))</span>
<span id="cb15-2"><a href="#cb15-2"></a>   mod.res <span class="ot">&lt;-</span> <span class="fu">mod.check</span>(g, clus)</span>
<span id="cb15-3"><a href="#cb15-3"></a>   <span class="fu">round</span>(mod.res, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2     3     4     5     6     7     8     9    10 
0.250 0.355 0.339 0.327 0.340 0.331 0.294 0.287 0.252 </code></pre>
</div>
</div>
<p>The degree-normalized Laplacian once again prefers the three-community partition, but also shows that the <em>six</em> community partition produces a high-quality clustering. Here’s how those look like:</p>
<div id="fig-friends3" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends3-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends3-1.png" class="img-fluid figure-img" data-ref-parent="fig-friends3" width="1152"></p>
<p></p><figcaption class="figure-caption">(a) Three Community Solution</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends3-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends3-2.png" class="img-fluid figure-img" data-ref-parent="fig-friends3" width="1152"></p>
<p></p><figcaption class="figure-caption">(b) Six Community Solution</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: Clustering of Nodes in the Law Firm Friendship Network Using the Degree-Normalized Ratio Cut</figcaption><p></p>
</figure>
</div>
</section>
<section id="clustering-using-the-eigenvectors-of-the-modularity-matrix" class="level2">
<h2 class="anchored" data-anchor-id="clustering-using-the-eigenvectors-of-the-modularity-matrix">Clustering Using the Eigenvectors of the Modularity Matrix</h2>
<p>As noted by <span class="citation" data-cites="fender_etal17">Fender et al. (<a href="#ref-fender_etal17" role="doc-biblioref">2017, 1796</a>)</span>, we can extend the spectral clustering approach based on the Laplacian and the normalized Laplacian to the modularity matrix <span class="math inline">\(\mathbf{B}\)</span>. That is, we cluster the graph by embedding the nodes in a set of dimensions defined by the eigendecomposition of <span class="math inline">\(\mathbf{B}\)</span>.</p>
<p>The main difference is that rather than using the eigenvectors corresponding to the <em>smallest</em> eigenvalues (as we did with <span class="math inline">\(\mathbf{L}\)</span>) we proceed in more typical fashion (as done with PCA and CA) and choose the eigenvectors corresponding to the <em>largest</em> ones.</p>
<p>This approach, once again, only requires small modifications to the one we used for the Laplacian:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>   mod.mat.cut <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">k =</span> <span class="dv">2</span>) {</span>
<span id="cb17-2"><a href="#cb17-2"></a>         A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(x))</span>
<span id="cb17-3"><a href="#cb17-3"></a>         n <span class="ot">&lt;-</span> <span class="fu">vcount</span>(x)</span>
<span id="cb17-4"><a href="#cb17-4"></a>         d <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">degree</span>(x))</span>
<span id="cb17-5"><a href="#cb17-5"></a>         B <span class="ot">&lt;-</span> A <span class="sc">-</span> (d <span class="sc">%*%</span> <span class="fu">t</span>(d))<span class="sc">/</span><span class="fu">sum</span>(A)</span>
<span id="cb17-6"><a href="#cb17-6"></a>         eig.B <span class="ot">&lt;-</span> <span class="fu">eigen</span>(B)</span>
<span id="cb17-7"><a href="#cb17-7"></a>         U <span class="ot">&lt;-</span> eig.B<span class="sc">$</span>vectors[, <span class="dv">1</span><span class="sc">:</span>k]</span>
<span id="cb17-8"><a href="#cb17-8"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(U)) {</span>
<span id="cb17-9"><a href="#cb17-9"></a>            U[i, ] <span class="ot">&lt;-</span> U[i, ]<span class="sc">/</span><span class="fu">norm</span>(<span class="fu">as.matrix</span>(U[i, ]), <span class="at">type =</span> <span class="st">"E"</span>)</span>
<span id="cb17-10"><a href="#cb17-10"></a>            }</span>
<span id="cb17-11"><a href="#cb17-11"></a>      <span class="fu">return</span>(U)</span>
<span id="cb17-12"><a href="#cb17-12"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key difference here is that we compute the modularity matrix <span class="math inline">\(\mathbf{B}\)</span> rather than <span class="math inline">\(\mathbf{L}\)</span> from the adjacency matrix <span class="math inline">\(\mathbf{A}\)</span> in line 5; we then plug <span class="math inline">\(\mathbf{B}\)</span> into the <code>eigen</code> function and proceed with normalizing in the same way as before.</p>
<p>Another difference is that rather than using a large number of eigenvalues (e.g., <span class="math inline">\(k = 6\)</span>), as we did when we were picking from the smallest ones, we now go for parsimony and pick a small rank (two-dimensional) representation of the original modularity matrix (<span class="math inline">\(k = 2\)</span>).</p>
<p>Let’s see how this works:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>   U <span class="ot">&lt;-</span> <span class="fu">mod.mat.cut</span>(g)</span>
<span id="cb18-2"><a href="#cb18-2"></a>   clus <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(U)</span>
<span id="cb18-3"><a href="#cb18-3"></a>   mod.res <span class="ot">&lt;-</span> <span class="fu">mod.check</span>(g, clus)</span>
<span id="cb18-4"><a href="#cb18-4"></a>   <span class="fu">round</span>(mod.res, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2     3     4     5     6     7     8     9    10 
0.264 0.366 0.331 0.317 0.306 0.304 0.224 0.187 0.166 </code></pre>
</div>
</div>
<p>We can see that the three-cluster solution does really well modularity-wise (<span class="math inline">\(Q = 0.37\)</span>), however, the four cluster solution also seems promising. The resulting communities are shown in <a href="#fig-friends3-1">Figure&nbsp;3 (a)</a> and <a href="#fig-friends3-2">Figure&nbsp;3 (b)</a>.</p>
<div id="fig-friends4" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends4-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends4-1.png" class="img-fluid figure-img" data-ref-parent="fig-friends4" width="1152"></p>
<p></p><figcaption class="figure-caption">(a) Three Community Solution</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-friends4-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-friends4-2.png" class="img-fluid figure-img" data-ref-parent="fig-friends4" width="1152"></p>
<p></p><figcaption class="figure-caption">(b) Four Community Solution</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;4: Clustering of Nodes in the Law Firm Friendship Network Using the Spectral Decomposition of the Modularity Matrix.</figcaption><p></p>
</figure>
</div>
</section>
<section id="spectral-clustering-of-two-mode-networks" class="level2">
<h2 class="anchored" data-anchor-id="spectral-clustering-of-two-mode-networks">Spectral Clustering of Two-Mode Networks</h2>
<p>We can use a variant of the spectral clustering approach to find multiple communities in two-mode networks <span class="citation" data-cites="wu_etal22">(<a href="#ref-wu_etal22" role="doc-biblioref">Wu, Gu, and Yang 2022</a>)</span>. This approach combines Correspondence Analysis (CA)—which we covered in the previous handout—and k-means clustering on multiple dimensions.</p>
<p>So let’s bring back our old friend, the Southern Women data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>   g <span class="ot">&lt;-</span> southern_women <span class="co">#southern women data</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>   A <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_biadjacency_matrix</span>(g)) <span class="co">#bi-adjacency matrix</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>   A2 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">as_adjacency_matrix</span>(g)) <span class="co">#bipartite adjacency matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s also compute the bi-adjacency modularity matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>   dp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rowSums</span>(A))</span>
<span id="cb21-2"><a href="#cb21-2"></a>   dg <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">colSums</span>(A))</span>
<span id="cb21-3"><a href="#cb21-3"></a>   dpdg <span class="ot">&lt;-</span> dp <span class="sc">%*%</span> <span class="fu">t</span>(dg) <span class="co">#person x group degree product matrix</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>   B <span class="ot">&lt;-</span> A <span class="sc">-</span> dpdg<span class="sc">/</span><span class="fu">sum</span>(A)</span>
<span id="cb21-5"><a href="#cb21-5"></a>   <span class="fu">round</span>(B, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           6/27   3/2  4/12  9/26  2/25  5/19  3/15  9/16   4/8  6/10  2/23
EVELYN     0.73  0.73  0.46  0.64  0.28  0.28 -0.90 -0.26 -0.08 -0.45 -0.36
LAURA      0.76  0.76  0.53 -0.31  0.37  0.37  0.21 -0.10 -0.94 -0.39 -0.31
THERESA   -0.27  0.73  0.46  0.64  0.28  0.28  0.10 -0.26 -0.08 -0.45 -0.36
BRENDA     0.76 -0.24  0.53  0.69  0.37  0.37  0.21 -0.10 -0.94 -0.39 -0.31
CHARLOTTE -0.13 -0.13  0.73  0.82  0.64 -0.36  0.55 -0.63 -0.54 -0.22 -0.18
FRANCES   -0.13 -0.13  0.73 -0.18  0.64  0.64 -0.45  0.37 -0.54 -0.22 -0.18
ELEANOR   -0.13 -0.13 -0.27 -0.18  0.64  0.64  0.55  0.37 -0.54 -0.22 -0.18
PEARL     -0.10 -0.10 -0.20 -0.13 -0.27  0.73 -0.34  0.53  0.60 -0.17 -0.13
RUTH      -0.13 -0.13 -0.27 -0.18  0.64 -0.36  0.55  0.37  0.46 -0.22 -0.18
VERNE     -0.13 -0.13 -0.27 -0.18 -0.36 -0.36  0.55  0.37  0.46 -0.22 -0.18
MYRNA     -0.13 -0.13 -0.27 -0.18 -0.36 -0.36 -0.45  0.37  0.46  0.78 -0.18
KATHERINE -0.20 -0.20 -0.40 -0.27 -0.54 -0.54 -0.67  0.06  0.19  0.66 -0.27
SYLVIA    -0.24 -0.24 -0.47 -0.31 -0.63 -0.63  0.21 -0.10  0.06  0.61 -0.31
NORA      -0.27 -0.27 -0.54 -0.36 -0.72  0.28  0.10 -1.26 -0.08  0.55  0.64
HELEN     -0.17 -0.17 -0.34 -0.22 -0.45 -0.45  0.44  0.21 -0.67  0.72  0.78
DOROTHY   -0.07 -0.07 -0.13 -0.09 -0.18 -0.18 -0.22  0.69  0.73 -0.11 -0.09
OLIVIA    -0.07 -0.07 -0.13 -0.09 -0.18 -0.18 -0.22 -0.31  0.73 -0.11  0.91
FLORA     -0.07 -0.07 -0.13 -0.09 -0.18 -0.18 -0.22 -0.31  0.73 -0.11  0.91
            4/7 11/21   8/3
EVELYN    -0.54 -0.27 -0.27
LAURA     -0.47 -0.24 -0.24
THERESA   -0.54 -0.27 -0.27
BRENDA    -0.47 -0.24 -0.24
CHARLOTTE -0.27 -0.13 -0.13
FRANCES   -0.27 -0.13 -0.13
ELEANOR   -0.27 -0.13 -0.13
PEARL     -0.20 -0.10 -0.10
RUTH      -0.27 -0.13 -0.13
VERNE      0.73 -0.13 -0.13
MYRNA      0.73 -0.13 -0.13
KATHERINE  0.60  0.80  0.80
SYLVIA     0.53  0.76  0.76
NORA       0.46  0.73  0.73
HELEN      0.66 -0.17 -0.17
DOROTHY   -0.13 -0.07 -0.07
OLIVIA    -0.13 -0.07 -0.07
FLORA     -0.13 -0.07 -0.07</code></pre>
</div>
</div>
<p>Great! Now, from this information we can compute a version of the bipartite modularity matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>   n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(A) <span class="sc">+</span> <span class="fu">ncol</span>(A)</span>
<span id="cb23-2"><a href="#cb23-2"></a>   Np <span class="ot">&lt;-</span> <span class="fu">nrow</span>(A)</span>
<span id="cb23-3"><a href="#cb23-3"></a>   names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rownames</span>(A), <span class="fu">colnames</span>(A))</span>
<span id="cb23-4"><a href="#cb23-4"></a>   B2 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, n) <span class="co">#all zeros matrix of dimensions (p + g) X (p + g)</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>   B2[<span class="dv">1</span><span class="sc">:</span>Np, (Np <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n] <span class="ot">&lt;-</span> B <span class="co">#putting B in the top right block</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>   B2[(Np <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>Np] <span class="ot">&lt;-</span> <span class="fu">t</span>(B) <span class="co">#putting B transpose in the lower-left block</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>   <span class="fu">rownames</span>(B2) <span class="ot">&lt;-</span> names</span>
<span id="cb23-8"><a href="#cb23-8"></a>   <span class="fu">colnames</span>(B2) <span class="ot">&lt;-</span> names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now let’s find the CA scores. This time will use the canned function <code>CA</code> from the the package <code>FactoMineR</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>   <span class="co">#install.packages("FactoMineR")</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>   <span class="fu">library</span>(FactoMineR)</span>
<span id="cb24-3"><a href="#cb24-3"></a>   CA.res <span class="ot">&lt;-</span> <span class="fu">CA</span>(A, <span class="at">graph =</span> <span class="cn">FALSE</span>, <span class="at">ncp =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which computes CA directly on the bi-adjacency matrix (the argument <code>ncp</code> asks to keep the first ten dimensions).</p>
<p>We can now extract the CA scores for persons and groups from the resulting object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>   eig.vec.p <span class="ot">&lt;-</span> CA.res<span class="sc">$</span>row<span class="sc">$</span>coord</span>
<span id="cb25-2"><a href="#cb25-2"></a>   eig.vec.g <span class="ot">&lt;-</span> CA.res<span class="sc">$</span>col<span class="sc">$</span>coord</span>
<span id="cb25-3"><a href="#cb25-3"></a>   <span class="fu">head</span>(eig.vec.p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Dim 1       Dim 2       Dim 3        Dim 4       Dim 5
EVELYN    -0.7994396 -0.11278306  0.12856965  0.491615655  0.36993238
LAURA     -0.8426887  0.03973055  0.11862978  0.286643489  0.10696165
THERESA   -0.6538505 -0.08107422  0.03285721  0.066653892  0.11835519
BRENDA    -0.8552592  0.05084420  0.26039689 -0.082978126  0.05028130
CHARLOTTE -0.9735517  0.03683948  0.66023345 -0.774105247  0.08510784
FRANCES   -0.7973597  0.05794469 -0.20558235 -0.001077288 -0.59307835
                 Dim 6        Dim 7       Dim 8         Dim 9      Dim 10
EVELYN    -0.007414199 -0.007447136 -0.02256155 -0.0160061655  0.08340311
LAURA      0.519058804  0.358983310  0.06243870  0.1954326939 -0.10193085
THERESA   -0.238792769  0.037114413  0.44547214 -0.1638696977  0.04645662
BRENDA     0.060849392 -0.093559773 -0.53495958 -0.1262516982  0.02818219
CHARLOTTE -0.721861078 -0.222554541  0.02152725 -0.0001022383 -0.04432666
FRANCES    0.178454033 -0.648007177  0.12713961  0.3578859472 -0.29201035</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>   <span class="fu">head</span>(eig.vec.g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Dim 1        Dim 2       Dim 3        Dim 4       Dim 5      Dim 6
6/27 -1.0510521 -0.013102803  0.40045025  0.624502007  0.53693139  0.6062955
3/2  -0.9662871 -0.090934069  0.22094083  0.758901614  0.60626508  0.2889617
4/12 -1.0357695 -0.002506996  0.39252639 -0.005949514  0.07005287 -0.1110437
9/26 -1.0359803 -0.046981456  0.64023822 -0.201296127  0.47641399 -0.7205873
2/25 -0.8840034  0.002527085  0.00616034 -0.304708001 -0.31330029 -0.1008760
5/19 -0.5723848 -0.007363883 -0.15907563  0.336653678 -0.55713599  0.3565649
            Dim 7       Dim 8       Dim 9       Dim 10
6/27  0.341243814 -0.78585220  0.09303009  0.022211664
3/2   0.514095893  0.77040262  0.02721689  0.064255000
4/12 -0.380608237  0.07861703  0.21614264 -0.322353047
9/26 -0.284177968 -0.10776494 -0.40181489  0.196215569
2/25  0.009376108  0.04679332  0.31794275  0.121060750
5/19 -0.215101435  0.05292157 -0.34808611  0.004513752</code></pre>
</div>
</div>
<p>Great! You can verify that these are the same scores we obtained in the last handout via a more elaborate route.</p>
<p>Now, we can just create our <code>U</code> matrix by stacking the person and group scores using the first three dimensions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>   U <span class="ot">&lt;-</span> <span class="fu">rbind</span>(eig.vec.p, eig.vec.g)[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb29-2"><a href="#cb29-2"></a>   <span class="fu">head</span>(U)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Dim 1       Dim 2       Dim 3
EVELYN    -0.7994396 -0.11278306  0.12856965
LAURA     -0.8426887  0.03973055  0.11862978
THERESA   -0.6538505 -0.08107422  0.03285721
BRENDA    -0.8552592  0.05084420  0.26039689
CHARLOTTE -0.9735517  0.03683948  0.66023345
FRANCES   -0.7973597  0.05794469 -0.20558235</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>   <span class="fu">tail</span>(U)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Dim 1      Dim 2       Dim 3
4/8   0.5140165 -0.4896890 -0.47959026
6/10  1.1173628  0.5729577  0.23464730
2/23  1.2219952 -2.0539686  0.69618973
4/7   1.0223902  0.5159415 -0.04625319
11/21 1.1742556  0.9078702  0.66121084
8/3   1.1742556  0.9078702  0.66121084</code></pre>
</div>
</div>
<p>Nice! Now we can just feed <code>U</code> to our <code>k.cuts</code> function to place persons and groups into cluster assignments beginning with two and ending with ten:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>   clus <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(U)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Of course, we can’t use the <code>mod.check</code> function we used earlier because that uses the standard method for checking the modularity in one-mode networks and doesn’t take into account the structural zeros in the bipartite graph.</p>
<p>So we need to come up with a custom method to check the modularity for the bipartite case.</p>
<p>First, we need a function that takes a cluster assignment vector containing numbers for each cluster <span class="math inline">\(k = \{1, 2, 3, \ldots C\}\)</span> and turns it into a dummy coded cluster assignment matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>   make.dummies <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb34-2"><a href="#cb34-2"></a>      vals <span class="ot">&lt;-</span> <span class="fu">unique</span>(x)</span>
<span id="cb34-3"><a href="#cb34-3"></a>      U <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">length</span>(x), <span class="fu">length</span>(vals))</span>
<span id="cb34-4"><a href="#cb34-4"></a>      <span class="cf">for</span> (k <span class="cf">in</span> vals) {</span>
<span id="cb34-5"><a href="#cb34-5"></a>         U[, k] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x <span class="sc">==</span> k)</span>
<span id="cb34-6"><a href="#cb34-6"></a>      }</span>
<span id="cb34-7"><a href="#cb34-7"></a>   <span class="fu">return</span>(U)</span>
<span id="cb34-8"><a href="#cb34-8"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test it out:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>   <span class="fu">make.dummies</span>(clus[[<span class="dv">3</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1] [,2] [,3] [,4]
 [1,]    0    1    0    0
 [2,]    0    1    0    0
 [3,]    0    1    0    0
 [4,]    0    1    0    0
 [5,]    0    1    0    0
 [6,]    0    1    0    0
 [7,]    0    1    0    0
 [8,]    0    0    0    1
 [9,]    0    0    0    1
[10,]    0    0    0    1
[11,]    0    0    0    1
[12,]    1    0    0    0
[13,]    1    0    0    0
[14,]    1    0    0    0
[15,]    1    0    0    0
[16,]    0    0    0    1
[17,]    0    0    1    0
[18,]    0    0    1    0
[19,]    0    1    0    0
[20,]    0    1    0    0
[21,]    0    1    0    0
[22,]    0    1    0    0
[23,]    0    1    0    0
[24,]    0    1    0    0
[25,]    0    1    0    0
[26,]    0    0    0    1
[27,]    0    0    0    1
[28,]    1    0    0    0
[29,]    0    0    1    0
[30,]    1    0    0    0
[31,]    1    0    0    0
[32,]    1    0    0    0</code></pre>
</div>
</div>
<p>Great! Looks like it works.</p>
<p>Finally, we need to write a custom function for bipartite modularity checking across different assignments:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>   mod.check2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, c, w) {</span>
<span id="cb37-2"><a href="#cb37-2"></a>      k <span class="ot">&lt;-</span> <span class="fu">length</span>(c)</span>
<span id="cb37-3"><a href="#cb37-3"></a>      m <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, k)</span>
<span id="cb37-4"><a href="#cb37-4"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k) {</span>
<span id="cb37-5"><a href="#cb37-5"></a>         u <span class="ot">&lt;-</span> <span class="fu">make.dummies</span>(c[[i]])</span>
<span id="cb37-6"><a href="#cb37-6"></a>         m[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(<span class="fu">t</span>(u) <span class="sc">%*%</span> x <span class="sc">%*%</span> u))<span class="sc">/</span><span class="fu">sum</span>(w)</span>
<span id="cb37-7"><a href="#cb37-7"></a>         }</span>
<span id="cb37-8"><a href="#cb37-8"></a>   <span class="fu">names</span>(m) <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">:</span>(k<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb37-9"><a href="#cb37-9"></a>   <span class="fu">return</span>(m)</span>
<span id="cb37-10"><a href="#cb37-10"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>mod.check2</code> needs three inputs: The bipartite modularity matrix, a list with different assignments of the nodes in the bipartite graph to different clusters, and the bipartite adjacency matrix. It returns a vector <code>m</code> with the modularities of each of the partitions in the list <code>c</code>.</p>
<p>And, now, for the big reveal:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>   <span class="fu">round</span>(<span class="fu">mod.check2</span>(B2, clus, A2), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2     3     4     5     6     7     8     9    10 
0.318 0.306 0.338 0.257 0.248 0.224 0.190 0.184 0.155 </code></pre>
</div>
</div>
<p>Looks like the spectral clustering results favor a four-community partition although the more parsimonious three and binary community partitions also look pretty good.</p>
<p><a href="#fig-women-1">Figure&nbsp;5 (a)</a> and <a href="#fig-women-2">Figure&nbsp;5 (b)</a> show a plot of the three and four community solutions according to the CA dimensions (since we already saw the binary partition in the CA handout).</p>
<p>Of course, just like we did with one-mode networks, we can also obtain a spectral clustering directly from the eigenvectors of the bipartite modularity matrix in just a couple of lines:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>   clusB <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(<span class="fu">eigen</span>(B2)<span class="sc">$</span>vectors[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb40-2"><a href="#cb40-2"></a>   <span class="fu">round</span>(<span class="fu">mod.check2</span>(B2, clusB, A2), <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2     3     4     5     6     7     8     9    10 
0.319 0.334 0.271 0.216 0.179 0.144 0.133 0.101 0.057 </code></pre>
</div>
</div>
<p>Here we create the <code>U</code> matrix from the first two dimensions of the eigendecomposition of the bipartite modularity matrix. The results suggest that the three community partition is optimal, although the two-community one also does well. The corresponding splits are shown in <a href="#fig-women-3">Figure&nbsp;5 (c)</a> and <a href="#fig-women-4">Figure&nbsp;5 (d)</a>.</p>
<p>Note that the main difference between CA and modularity based clustering in two-mode networks is that modularity seems to prefer evenly balanced communities (in terms of number of nodes), while CA does not mind grouping nodes into small communities (like <span class="math inline">\(\{Flora, Nora, 2/23\}\)</span>)</p>
<div id="fig-women" class="cell quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-women-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-women-1.png" class="img-fluid figure-img" data-ref-parent="fig-women" width="1152"></p>
<p></p><figcaption class="figure-caption">(a) Three Community Solution (CA)</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-women-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-women-2.png" class="img-fluid figure-img" data-ref-parent="fig-women" width="1152"></p>
<p></p><figcaption class="figure-caption">(b) Four Community Solution (CA)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-women-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-women-3.png" class="img-fluid figure-img" data-ref-parent="fig-women" width="1152"></p>
<p></p><figcaption class="figure-caption">(c) Two Community Solution (Bipartite Modularity)</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-women-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spectral_files/figure-html/fig-women-4.png" class="img-fluid figure-img" data-ref-parent="fig-women" width="1152"></p>
<p></p><figcaption class="figure-caption">(d) Three Community Solution (Bipartite Modularity)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;5: Spectral Clustering of Nodes in the Southern Women Data.</figcaption><p></p>
</figure>
</div>
</section>
<section id="bipartite-modularity-allowing-people-and-groups-to-belong-to-different-number-of-communities" class="level2">
<h2 class="anchored" data-anchor-id="bipartite-modularity-allowing-people-and-groups-to-belong-to-different-number-of-communities">Bipartite Modularity Allowing People and Groups to Belong to Different Number of Communities</h2>
<p>One limitation of Barber’s approach to computing the modularity is that it can only be used under the assumption that the number of communities is the <em>same</em> for both persons and groups.</p>
<p>However, it could be that the optimal partition is actually one in which the people node set is split into a different number of clusters than the group node set.</p>
<p>So we need a way to evaluate the modularity of a partition when we have different number of communities on the people and group side.</p>
<p>Here’s how to do it.</p>
<p>First, we generate two separate candidate community assignments for people and groups via spectral clustering from CA using the first six eigenvectors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>   k.cuts.p <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(CA.res<span class="sc">$</span>row<span class="sc">$</span>coord[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb42-2"><a href="#cb42-2"></a>   k.cuts.g <span class="ot">&lt;-</span> <span class="fu">k.cuts</span>(CA.res<span class="sc">$</span>col<span class="sc">$</span>coord[, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As an example, let’s pick the solution that partitions people into four communities and the groups into three communities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>   C.p <span class="ot">&lt;-</span> k.cuts.p[[<span class="dv">3</span>]]</span>
<span id="cb43-2"><a href="#cb43-2"></a>   C.g <span class="ot">&lt;-</span> k.cuts.g[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Given this information, we can create a <span class="math inline">\(4 \times 3\)</span> matrix recording the proportion of ties in the network that go from person-community <span class="math inline">\(l\)</span> to group-community <span class="math inline">\(m\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>   e <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">4</span>, <span class="dv">3</span>)</span>
<span id="cb44-2"><a href="#cb44-2"></a>   <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb44-3"><a href="#cb44-3"></a>      <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb44-4"><a href="#cb44-4"></a>         e[l, m] <span class="ot">=</span> <span class="fu">sum</span>(A[C.p <span class="sc">==</span> l, C.g <span class="sc">==</span> m]) <span class="sc">*</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(A)</span>
<span id="cb44-5"><a href="#cb44-5"></a>      }</span>
<span id="cb44-6"><a href="#cb44-6"></a>   }</span>
<span id="cb44-7"><a href="#cb44-7"></a>   <span class="fu">round</span>(e, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,] 0.19 0.02 0.17
[2,] 0.00 0.00 0.04
[3,] 0.00 0.02 0.02
[4,] 0.00 0.00 0.53</code></pre>
</div>
</div>
<p>For instance, this matrix says that 53% of the ties in the Southern women data go from people in the fourth community to groups in the third community, according to the CA spectral partition.</p>
<p><span class="citation" data-cites="suzuki_wakita09">Suzuki and Wakita (<a href="#ref-suzuki_wakita09" role="doc-biblioref">2009</a>)</span>, building on work by <span class="citation" data-cites="murata09">Murata (<a href="#ref-murata09" role="doc-biblioref">2009</a>)</span>, suggest using the <code>e</code> matrix above to compute the modularity of any pair of person/group community assignment according to the following formula:</p>
<p><span class="math display">\[
Q = \frac{1}{2}\sum_{l, m}\frac{e_{lm}}{e_{l+}}\left(e_{lm} - e_{l+}e_{+m}\right)
\]</span></p>
<p>Where <span class="math inline">\(e_{lm}\)</span> is the proportion of edges connecting people in the <span class="math inline">\(l^{th}\)</span> person-community to groups in the <span class="math inline">\(m^{th}\)</span> event-community, <span class="math inline">\(e_{l+}\)</span> is the proportion of edges originating from person-community <span class="math inline">\(i\)</span> (the corresponding entry of the row sum of <code>e</code>), and <span class="math inline">\(e_{+m}\)</span> is the proportion of edges originating from nodes in group-community <span class="math inline">\(j\)</span> (the corresponding entry of the column sum of <code>e</code>).</p>
<p>So the idea is that given a partition of the person nodes into <span class="math inline">\(L\)</span> communities and a partition of the group nodes into <span class="math inline">\(M\)</span> communities, we can generate an <code>e</code> matrix like the one above and compute the corresponding modularity of that person/group partition using the above equation.</p>
<p>Here’s a function that computes the <code>e</code> matrix from a pair of person/group partitions and then returns the <span class="math inline">\(Q\)</span> value corresponding to that matrix using the above formula:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>   find.mod <span class="ot">&lt;-</span> <span class="cf">function</span>(w, x, y) {</span>
<span id="cb46-2"><a href="#cb46-2"></a>      Cx <span class="ot">&lt;-</span> <span class="fu">max</span>(x)</span>
<span id="cb46-3"><a href="#cb46-3"></a>      Cy <span class="ot">&lt;-</span> <span class="fu">max</span>(y)</span>
<span id="cb46-4"><a href="#cb46-4"></a>      M <span class="ot">&lt;-</span> <span class="fu">sum</span>(w)</span>
<span id="cb46-5"><a href="#cb46-5"></a>      e <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, Cx, Cy)</span>
<span id="cb46-6"><a href="#cb46-6"></a>      <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Cx) {</span>
<span id="cb46-7"><a href="#cb46-7"></a>         <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Cy) {</span>
<span id="cb46-8"><a href="#cb46-8"></a>            e[l, m] <span class="ot">=</span> <span class="fu">sum</span>(w[x <span class="sc">==</span> l, y <span class="sc">==</span> m]) <span class="sc">*</span> <span class="dv">1</span><span class="sc">/</span>M</span>
<span id="cb46-9"><a href="#cb46-9"></a>         }</span>
<span id="cb46-10"><a href="#cb46-10"></a>      }</span>
<span id="cb46-11"><a href="#cb46-11"></a>      Q <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb46-12"><a href="#cb46-12"></a>      a <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(e)</span>
<span id="cb46-13"><a href="#cb46-13"></a>      b <span class="ot">&lt;-</span> <span class="fu">colSums</span>(e)</span>
<span id="cb46-14"><a href="#cb46-14"></a>      <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Cx) {</span>
<span id="cb46-15"><a href="#cb46-15"></a>         <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Cy) {</span>
<span id="cb46-16"><a href="#cb46-16"></a>            Q <span class="ot">&lt;-</span> Q <span class="sc">+</span> (e[l, m]<span class="sc">/</span>a[l] <span class="sc">*</span> (e[l, m] <span class="sc">-</span> a[l]<span class="sc">*</span>b[m]))</span>
<span id="cb46-17"><a href="#cb46-17"></a>         }</span>
<span id="cb46-18"><a href="#cb46-18"></a>      }</span>
<span id="cb46-19"><a href="#cb46-19"></a>   <span class="fu">return</span>(Q<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb46-20"><a href="#cb46-20"></a>   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So for the <code>e</code> matrix from the above example, <span class="math inline">\(Q\)</span> would be:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>   <span class="fu">find.mod</span>(A,  k.cuts.p[[<span class="dv">3</span>]],  k.cuts.g[[<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.07220939</code></pre>
</div>
</div>
<p>Which looks like a positive number. But is it the biggest of all the possible community partition combinations between people and groups?</p>
<p>To answer this question, we can use the <code>find.mod</code> function to compute the modularity between <em>every pair</em> of partitions between people and groups that we calculated earlier. Since we computed eight different partitions for people and groups this leads to <span class="math inline">\(8 \times 8 = 64\)</span> pairs.</p>
<p>Here’s a wrapper function over <code>find.mod</code> that computes the corresponding modularity values for each partition pair:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>   mod.mat <span class="ot">&lt;-</span> <span class="cf">function</span>(d) {</span>
<span id="cb49-2"><a href="#cb49-2"></a>     q <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, d, d)</span>
<span id="cb49-3"><a href="#cb49-3"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>d) {</span>
<span id="cb49-4"><a href="#cb49-4"></a>         <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>d) {</span>
<span id="cb49-5"><a href="#cb49-5"></a>               q[i, j] <span class="ot">&lt;-</span> <span class="fu">find.mod</span>(A,  k.cuts.p[[i]],  k.cuts.g[[j]])</span>
<span id="cb49-6"><a href="#cb49-6"></a>         }</span>
<span id="cb49-7"><a href="#cb49-7"></a>      }</span>
<span id="cb49-8"><a href="#cb49-8"></a>    <span class="fu">return</span>(q)</span>
<span id="cb49-9"><a href="#cb49-9"></a>   }</span>
<span id="cb49-10"><a href="#cb49-10"></a>   Q <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mod.mat</span>(<span class="dv">8</span>), <span class="dv">3</span>)</span>
<span id="cb49-11"><a href="#cb49-11"></a>   Q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
[1,] 0.102 0.058 0.042 0.031 0.032 0.033 0.029 0.024
[2,] 0.106 0.066 0.050 0.038 0.039 0.041 0.035 0.033
[3,] 0.104 0.072 0.056 0.042 0.045 0.043 0.037 0.039
[4,] 0.112 0.074 0.069 0.055 0.058 0.056 0.050 0.046
[5,] 0.112 0.075 0.069 0.058 0.061 0.060 0.054 0.050
[6,] 0.110 0.074 0.075 0.064 0.061 0.063 0.058 0.054
[7,] 0.111 0.077 0.077 0.066 0.067 0.068 0.062 0.059
[8,] 0.111 0.077 0.078 0.067 0.067 0.070 0.064 0.060</code></pre>
</div>
</div>
<p>Interestingly, the analysis suggests that the maximum modularity <span class="math inline">\(Q = 0.112\)</span> is obtained with a partition of people into five communities and groups into two communities corresponding to cells <span class="math inline">\((4, 1)\)</span> of the above matrix.</p>
<p>Here’s what this community assignment looks like in the Southern Women data:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="spectral_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="1152"></p>
<p></p><figcaption class="figure-caption">Spectral Clustering of Nodes in the Southern Women Data with Optimal Community Assignment Obtained via the Suzuki Modularity, with Five Communities for People, Two Communities for Groups.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The analysis separates two groups of densely connected actors of size six and five, respectively, namely, <span class="math inline">\(\{Brenda, Theresa, Laura, Frances, Evelyn, Eleanor\}\)</span> and <span class="math inline">\(\{Katherine, Nora, Sylvia, Myrna, Helen\}\)</span> along with their corresponding events from the one another. In the same way, <span class="math inline">\(\{Pearl, Dorothy, Ruth, Verne\}\)</span> form a community of more peripheral actors who selectively attend the more popular events; <span class="math inline">\(\{Flora, Olivia\}\)</span> are a two-actor community occupying the most peripheral position. Among the core set of actors, <span class="math inline">\(\{Charlotte\}\)</span> occupies a singleton-community of her own.</p>
<p>Events are partitioned into two broad groups: One the one hand, we have those selectively selectively attended by the larger community of densely connected actors along with the most popular events; on the other hand, we have the events selectively attended by the smaller group of densely connected actors.</p>
<p>In this handout we have seen that spectral clustering via the Laplacian, normalized Laplacian or the modularity matrix (and CA or the modularity in the bipartite case) produces high-quality partitions, highlighting the core groups in the data. It is a simple and easy to implement option to add to your arsenal.</p>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-fender_etal17" class="csl-entry" role="doc-biblioentry">
Fender, Alexandre, Nahid Emad, Serge Petiton, and Maxim Naumov. 2017. <span>“Parallel Modularity Clustering.”</span> <em>Procedia Computer Science</em> 108: 1793–1802.
</div>
<div id="ref-fouss_etal16" class="csl-entry" role="doc-biblioentry">
Fouss, François, Marco Saerens, and Masashi Shimbo. 2016. <em>Algorithms and Models for Network Data and Link Analysis</em>. Cambridge University Press.
</div>
<div id="ref-murata09" class="csl-entry" role="doc-biblioentry">
Murata, Tsuyoshi. 2009. <span>“Community Division of Heterogeneous Networks.”</span> In <em>Complex Sciences: First International Conference, Complex 2009, Shanghai, China, February 23-25, 2009. Revised Papers, Part 1 1</em>, 1011–22. Springer.
</div>
<div id="ref-suzuki_wakita09" class="csl-entry" role="doc-biblioentry">
Suzuki, Kenta, and Ken Wakita. 2009. <span>“Extracting Multi-Facet Community Structure from Bipartite Networks.”</span> In <em>2009 International Conference on Computational Science and Engineering</em>, 4:312–19. IEEE.
</div>
<div id="ref-vonluxburg07" class="csl-entry" role="doc-biblioentry">
Von Luxburg, Ulrike. 2007. <span>“A Tutorial on Spectral Clustering.”</span> <em>Statistics and Computing</em> 17: 395–416.
</div>
<div id="ref-wu_etal22" class="csl-entry" role="doc-biblioentry">
Wu, Guolin, Changgui Gu, and Huijie Yang. 2022. <span>“A Spectral Method of Modularity for Community Detection in Bipartite Networks.”</span> <em>Europhysics Letters</em> 137 (3): 31001.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Not as a reference to ghosts, but because the eigendecomposition of a matrix is sometimes also called the <strong>spectral decomposition</strong>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>If <span class="math inline">\(\mathbf{A}\)</span> is not connected there will be as many zero eigenvalues in the eigendecomposition of <span class="math inline">\(\mathbf{L}\)</span> as there are components in <span class="math inline">\(\mathbf{A}\)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>